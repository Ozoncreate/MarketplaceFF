<!doctype html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>рассчет услуг Фуллфилмента ИП Бардош Р.Е. ИНН 251005851477</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
	<!-- XLSX (with styling) for true .xlsx export -->
	<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
	<style>
		@media print {
			body * {
				visibility: hidden;
			}
			#print-content, #print-content * {
				visibility: visible;
			}
			#print-content {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
			}
		}
	</style>
	<style>
		:root {
			--bg: #0f1115;
			--card: #171923;
			--muted: #8b95a7;
			--text: #e6e8ee;
			--accent: #4f8cff;
			--accent-2: #22c55e;
			--danger: #ef4444;
			--border: #242839;
				/* Glass additions */
				--glass-bg: rgba(23, 25, 35, 0.55);
				--glass-bg-2: rgba(23, 25, 35, 0.35);
				--glass-stroke: rgba(255, 255, 255, 0.08);
				--glow: 0 10px 30px rgba(79, 140, 255, 0.15);
				--shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
		}

		* { box-sizing: border-box; }
		html, body { height: 100%; }
		body {
			margin: 0;
			background: linear-gradient(180deg, #0e1014 0%, #0b0d12 100%);
			color: var(--text);
			font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
		}

		.container {
			max-width: 1100px;
			margin: 32px auto;
			padding: 0 16px;
		}

			/* Glassmorphism theme */
			.header {
				background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
				backdrop-filter: saturate(160%) blur(14px);
				-webkit-backdrop-filter: saturate(160%) blur(14px);
				border: 1px solid var(--glass-stroke);
				border-radius: 16px;
				padding: 18px 16px;
				box-shadow: var(--shadow);
			}

			.card {
				background: linear-gradient(180deg, var(--glass-bg), var(--glass-bg-2));
				backdrop-filter: saturate(160%) blur(12px);
				-webkit-backdrop-filter: saturate(160%) blur(12px);
				border: 1px solid var(--glass-stroke);
				border-radius: 16px;
				box-shadow: var(--shadow);
				padding: 14px;
			}

			.section-header {
				background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
				border: 1px solid var(--glass-stroke);
				border-radius: 12px;
				padding: 10px 12px;
				transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
			}
			.section-header:hover {
				transform: translateY(-1px);
				box-shadow: var(--glow);
				border-color: rgba(79, 140, 255, 0.25);
			}

			.service-item {
				display: flex;
				align-items: center;
				gap: 12px;
				padding: 10px 12px;
				border-radius: 12px;
				border: 1px solid var(--glass-stroke);
				background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
			}
			.service-item + .service-item { margin-top: 8px; }

			input[type="number"], input[type="text"], select {
				background: rgba(255,255,255,0.04);
				border: 1px solid var(--glass-stroke);
				color: var(--text);
				border-radius: 10px;
				height: 36px;
				padding: 0 10px;
				outline: none;
				transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
			}
			/* Remove native number spinners */
			input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
			input[type="number"]::-webkit-outer-spin-button,
			input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
			input[type="number"]:focus, input[type="text"]:focus, select:focus {
				border-color: rgba(79, 140, 255, 0.45);
				box-shadow: 0 0 0 4px rgba(79, 140, 255, 0.08);
				background: rgba(255,255,255,0.06);
			}

			button.primary, button.secondary {
				border-radius: 12px;
				border: 1px solid var(--glass-stroke);
				padding: 10px 14px;
				cursor: pointer;
				font-weight: 600;
				transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
				-webkit-tap-highlight-color: transparent;
				touch-action: manipulation;
			}
			button.primary {
				background: linear-gradient(180deg, rgba(79,140,255,0.35), rgba(79,140,255,0.25));
				color: #fff;
				box-shadow: var(--glow);
			}
			button.secondary {
				background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
				color: var(--text);
			}
			button.primary:hover { box-shadow: 0 8px 26px rgba(79, 140, 255, 0.25); transform: translateY(-1px); }
			button.secondary:hover { box-shadow: var(--glow); transform: translateY(-1px); }

			/* Prices and totals */
			.service-price { color: var(--muted); }
			.service-total {
				color: var(--text);
				font-weight: 700;
			}

			/* Floating total glass override */
			#floatingTotal {
				background: linear-gradient(180deg, rgba(79,140,255,0.25), rgba(79,140,255,0.2)) !important;
				backdrop-filter: blur(12px) saturate(160%) !important;
				-webkit-backdrop-filter: blur(12px) saturate(160%) !important;
				border: 1px solid rgba(255,255,255,0.18) !important;
				box-shadow: 0 10px 30px rgba(79,140,255,0.25) !important;
				pointer-events: none !important; /* не блокировать клики по странице */
				z-index: 0 !important;
			}
			/* Поверх любых плавающих блоков */
			.header, .card, .section-header, .service-item { position: relative; z-index: 2; }

			/* Гарантируем кликабельность интерактивных элементов */
			.section-header, .service-item, .service-item *,
			button, input, select, label { pointer-events: auto; }
			.section-header, .service-item, button, label { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

			/* Collapsible area */
			.collapsible-content {
				border-left: 1px dashed rgba(255,255,255,0.08);
				margin-left: 6px;
				padding-left: 6px;
				overflow: hidden;
				max-height: 0;
				transition: max-height .3s ease;
				-webkit-overflow-scrolling: touch;
			}
			.collapsible-content.open { max-height: none; overflow: visible; }

			/* Micro animations */
			@keyframes subtleGlow {
				0% { box-shadow: 0 0 0 rgba(79,140,255,0); }
				50% { box-shadow: 0 0 16px rgba(79,140,255,0.18); }
				100% { box-shadow: 0 0 0 rgba(79,140,255,0); }
			}
			button.primary:focus-visible { animation: subtleGlow 1.2s ease; }
			.service-item:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.18); }
			.toggle-icon { transition: transform .25s ease; }

		.header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 16px;
			margin-bottom: 16px;
		}

		.title {
			margin: 0;
			font-size: 22px;
			font-weight: 700;
		}

		.controls {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			align-items: center;
		}

		select, input[type="text"], input[type="number"] {
			background: var(--card);
			border: 1px solid var(--border);
			color: var(--text);
			padding: 10px 12px;
			border-radius: 10px;
			outline: none;
			transition: border-color .15s ease;
		}
		select:focus, input:focus { border-color: var(--accent); }

		button {
			background: var(--accent);
			color: white;
			border: 0;
			padding: 10px 14px;
			border-radius: 10px;
			cursor: pointer;
			font-weight: 600;
			transition: transform .05s ease, opacity .2s ease, box-shadow .2s ease;
			box-shadow: 0 6px 16px rgba(79, 140, 255, .25);
		}
		button:active { transform: translateY(1px); }
		button.secondary {
			background: transparent;
			border: 1px solid var(--border);
			color: var(--text);
			box-shadow: none;
		}
		button.danger { background: var(--danger); box-shadow: 0 6px 16px rgba(239, 68, 68, .25); }
		button.success { background: var(--accent-2); box-shadow: 0 6px 16px rgba(34, 197, 94, .25); }

		.card {
			background: rgba(23, 25, 35, .9);
			backdrop-filter: saturate(140%) blur(6px);
			border: 1px solid var(--border);
			border-radius: 14px;
			padding: 16px;
		}

		.service-item {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 12px;
			background: linear-gradient(180deg, #151824, #141724);
			border: 1px solid var(--border);
			border-radius: 12px;
			margin-bottom: 8px;
			transition: border-color .15s ease;
		}
		.service-item:hover { border-color: var(--accent); }

		.service-checkbox {
			width: 18px;
			height: 18px;
			accent-color: var(--accent);
		}

		.summary {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 10px 16px;
			margin-top: 16px;
			align-items: center;
		}
		.summary .label { color: var(--muted); }
		.summary .value { font-weight: 700; }

		.footer-actions {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
			margin-top: 16px;
		}

		.footer {
			margin-top: 32px;
			padding: 16px 0;
			border-top: 1px solid var(--border);
			text-align: center;
		}

		.footer-content {
			max-width: 1100px;
			margin: 0 auto;
		}

		.footer-info {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 8px;
		}

		.footer-name {
			font-size: 14px;
			font-weight: 600;
			color: var(--text);
		}

		.footer-details {
			display: flex;
			flex-direction: column;
			gap: 4px;
			font-size: 12px;
			color: var(--muted);
		}

		.footer-details div {
			line-height: 1.4;
		}

		@media (max-width: 720px) {
				.container { padding: 0 12px; }
				.title { font-size: 18px; }
				.header { padding: 12px; border-radius: 12px; }
				.card { padding: 12px; border-radius: 12px; }
				.section-header { padding: 10px; border-radius: 10px; }
				/* Верхние три поля в одну колонку */
				.card > div[style*="grid-template-columns: repeat(3"] { grid-template-columns: 1fr !important; }
				.card > div[style*="grid-template-columns: repeat(3"] label { width: 100%; }
				/* Услуги — в колонку */
				.service-item { flex-direction: column; align-items: flex-start; gap: 8px; }
				.service-item > div:last-child { align-self: flex-end; }
				/* Плавающее итого — вниз и компактнее */
				#floatingTotal { left: 12px; right: 12px; top: auto !important; bottom: 12px; min-width: auto; font-size: 14px; padding: 12px 14px; }
				/* Заголовки секций — компактный вид */
				.section-header .toggle-icon { font-size: 16px; }
				.section-header > div:first-child { font-size: 15px !important; }
				/* Поля количества — кнопки ближе и крупнее */
				button.secondary { padding: 8px 12px; }
				input[type="number"], input[type="text"], select { height: 38px; }
		}
		
		/* Стили для зачеркивания цен при скидке */
		.service-price-discounted {
			position: relative;
		}
		.service-price-discounted::before {
			content: attr(data-original-price);
			text-decoration: line-through;
			color: #999;
			margin-right: 8px;
		}
		.service-price-discounted::after {
			content: attr(data-discounted-price);
			color: var(--primary);
			font-weight: bold;
		}
		
		.block-total-discounted {
			position: relative;
		}
		.block-total-discounted::before {
			content: attr(data-original-price);
			text-decoration: line-through;
			color: #999;
			margin-right: 8px;
		}
		.block-total-discounted::after {
			content: attr(data-discounted-price);
			color: var(--primary);
			font-weight: bold;
		}
		
		.service-total-discounted {
			position: relative;
		}
		.service-total-discounted::before {
			content: attr(data-original-price);
			text-decoration: line-through;
			color: #999;
			margin-right: 8px;
		}
		.service-total-discounted::after {
			content: attr(data-discounted-price);
			color: var(--primary);
			font-weight: bold;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1 class="title">Высокотехнологичный фулфилмент во Владивостоке WB|Ozon</h1>
			<div class="controls">
				<button id="resetAll" class="secondary">Сбросить</button>
			</div>
		</div>

		<!-- Плавающее окно с общей суммой -->
		<div id="floatingTotal" style="position: fixed; top: 20px; right: 20px; background: var(--primary); color: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-weight: 700; font-size: 16px; min-width: 200px; text-align: center; transition: all 0.3s ease;">
			<div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Общая сумма</div>
			<div id="floatingTotalAmount">0 ₽</div>
		</div>

		<div class="card" style="margin-bottom: 12px">
			<div style="display:grid; gap: 12px; grid-template-columns: repeat(3, minmax(160px, 1fr)); align-items: end; justify-content: center; max-width: 600px; margin: 0 auto;">
				<div>
					<div style="color: var(--muted); margin-bottom:6px">Количество паллет в поставке</div>
					<div style="display:flex; align-items:center; gap:6px;">
						<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="-1" data-target="k1">−</button>
						<input id="k1" type="number" min="0" step="1" value="0" style="width:100%;">
						<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="1" data-target="k1">+</button>
					</div>
				</div>
				<div>
					<div style="color: var(--muted); margin-bottom:6px">Количество коробок в поставке</div>
					<div style="display:flex; align-items:center; gap:6px;">
						<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="-1" data-target="k2">−</button>
						<input id="k2" type="number" min="0" step="1" value="0" style="width:100%;">
						<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="1" data-target="k2">+</button>
					</div>
				</div>
				<div>
					<div style="color: var(--muted); margin-bottom:6px">Количество единиц товара в поставке</div>
					<div style="display:flex; align-items:center; gap:6px;">
						<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="-1" data-target="k3">−</button>
						<input id="k3" type="number" min="0" step="1" value="0" style="width:100%;">
						<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="1" data-target="k3">+</button>
					</div>
				</div>
			</div>
		</div>

		<div class="card">
			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; cursor:pointer" onclick="toggleSection('services')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Приёмка/Отгрузка товара</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal1" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services" class="collapsible-content" style="display:none">
				<div id="servicesList"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services2')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Действия с товаром</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal2" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services2" class="collapsible-content" style="display:none">
				<div id="servicesList2"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services3')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Стикеровка</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal3" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services3" class="collapsible-content" style="display:none">
				<div id="servicesList3"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services4')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Проверка/обработка товара</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal4" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services4" class="collapsible-content" style="display:none">
				<div id="servicesList4"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services5')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Хранение</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal5" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services5" class="collapsible-content" style="display:none">
				<div id="servicesList5"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services6')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Дополнительная упаковка</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal6" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services6" class="collapsible-content" style="display:none">
				<div id="servicesList6"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services7')">
				<div style="font-weight:700; color: var(--text); font-size:16px">FBS</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal7" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services7" class="collapsible-content" style="display:none">
				<div id="servicesList7"></div>
			</div>

			<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services8')">
				<div style="font-weight:700; color: var(--text); font-size:16px">Дополнительные услуги</div>
				<div style="display:flex; align-items:center; gap:10px;">
					<div id="blockTotal8" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
					<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
				</div>
			</div>
			<div id="services8" class="collapsible-content" style="display:none">
				<div id="servicesList8"></div>
			</div>

		<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin:16px 0 10px; cursor:pointer" onclick="toggleSection('services9')">
			<div style="font-weight:700; color: var(--text); font-size:16px">Работа с личным кабинетом</div>
			<div style="display:flex; align-items:center; gap:10px;">
				<div id="blockTotal9" style="font-weight:700; color: var(--text); font-size:14px; min-width:80px; text-align:right;">0 ₽</div>
				<div class="toggle-icon" style="font-size:18px; transition:transform 0.2s ease">▼</div>
			</div>
		</div>
		<div id="services9" class="collapsible-content" style="display:none">
			<div id="servicesList9"></div>
		</div>

			<div style="display:grid; gap: 12px; grid-template-columns: repeat(3, minmax(180px, 1fr)); margin-top: 8px">
				<label>
					<div style="color: var(--muted); margin-bottom:6px">Скидка, %</div>
					<input id="discount" type="number" min="0" max="100" step="1" value="0">
				</label>
				<label>
					<div style="color: var(--muted); margin-bottom:6px">НДС, %</div>
					<input id="vat" type="number" min="0" max="100" step="1" value="20">
				</label>
				<label>
					<div style="color: var(--muted); margin-bottom:6px">Примечание (необязательно)</div>
					<input id="note" type="text" placeholder="Например, сроки, адрес, контакт...">
				</label>
			</div>

			<div class="summary">
				<div class="label">Подытог</div>
				<div class="value" id="subtotal">—</div>
				<div class="label">Скидка</div>
				<div class="value" id="discountAmount">—</div>
				<div class="label">НДС</div>
				<div class="value" id="vatAmount">—</div>
				<div class="label" style="font-size:16px">Итого</div>
				<div class="value" id="grandTotal" style="font-size:20px; color: var(--accent-2)">—</div>
			</div>

			<div class="footer-actions">
				<button id="generatePricePDF" class="secondary">Прайс PDF</button>
				<button id="generatePriceXLS" class="secondary">Прайс XLS</button>
				<button id="generateOrderXLS" class="primary">Заявка</button>
			</div>
		</div>

		<footer class="footer">
			<div class="footer-content">
				<div class="footer-info">
					<div class="footer-name">ИП Бардош Роман Евгеньевич</div>
					<div class="footer-details">
						<div>ИНН 251005851477</div>
						<div>Номер для связи и заявок: 89532132582</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

	<script>
		function toggleSection(sectionId) {
			const content = document.getElementById(sectionId);
			const icon = document.querySelector(`[onclick="toggleSection('${sectionId}')"] .toggle-icon`);
			if (!content) return;
			const isOpen = content.classList.contains('open');
			if (!isOpen) {
				content.style.display = 'block';
				// старт с нулевой высоты
				content.style.overflow = 'hidden';
				content.style.maxHeight = '0px';
				// следующей тик — до полной высоты
				requestAnimationFrame(() => {
					content.style.maxHeight = content.scrollHeight + 'px';
				});
				// после окончания анимации — снять ограничение, чтобы страница могла прокручиваться
				const onEnd = () => {
					content.classList.add('open');
					content.style.maxHeight = 'none';
					content.style.overflow = 'visible';
					content.removeEventListener('transitionend', onEnd);
				};
				content.addEventListener('transitionend', onEnd);
				if (icon) { icon.style.transform = 'rotate(180deg)'; }
				if (typeof syncQuantitiesFromContext === 'function') {
					syncQuantitiesFromContext();
					if (typeof window.calculateTotals === 'function') {
						window.calculateTotals();
					}
				}
			} else {
				// если было без ограничения, сначала зафиксировать текущую высоту
				if (getComputedStyle(content).maxHeight === 'none') {
					content.style.maxHeight = content.scrollHeight + 'px';
				}
				content.classList.remove('open');
				// затем анимировать до 0
				requestAnimationFrame(() => {
					content.style.overflow = 'hidden';
					content.style.maxHeight = '0px';
				});
				const onCloseEnd = () => {
					content.style.display = 'none';
					content.removeEventListener('transitionend', onCloseEnd);
				};
				content.addEventListener('transitionend', onCloseEnd);
				if (icon) { icon.style.transform = 'rotate(0deg)'; }
			}
		}

		(function() {
			// ===== Конфигурация (редактируйте под свои услуги и правила расчёта) =====
			const CONFIG = {
				services: [
					{ name: 'Приём товара + пересчет товара', unit: 'шт', basePrice: 3, multiplier: 'k3' },
					{ name: 'Выгрузка товара "Короб"', unit: 'шт', basePrice: 25, multiplier: 'k2' },
					{ name: 'Погрузка товара "Короб"', unit: 'шт', basePrice: 25, multiplier: 'k2' },
					{ name: 'Выгрузка товара "Паллет"', unit: 'шт', basePrice: 250, multiplier: 'k1' },
					{ name: 'Погрузка товара "Паллет"', unit: 'шт', basePrice: 250, multiplier: 'k1' },
				],
				services9: [
					{ name: 'Создание заявки на поставку на 1 кластер в ЛК', unit: 'услуга', basePrice: 1100, multiplier: 'custom', customLabel: 'кол-во заявок' }
				],
				services2: [
					{ name: 'Укладка в короба', unit: 'шт', basePrice: 70, multiplier: 'k2' },
					{ name: 'Достать/Вложить', unit: 'шт', basePrice: 5, multiplier: 'k3' },
					{ name: 'Вложение вкладыша', unit: 'шт', basePrice: 4, multiplier: 'k3' },
					{ name: 'Вложить товар в пакет (поф/слайдер)', unit: 'шт', basePrice: 3, multiplier: 'k3' },
					{ name: 'Взвешивание товара', unit: 'шт', basePrice: 45, multiplier: 'k3' },
					{ name: 'Паллетирование (входит: паллета, укладка, пленка и маркировка)', unit: 'паллет', basePrice: 1400, multiplier: 'k1' },
					{ name: 'Фиксация упаковки скотчем', unit: 'шт', basePrice: 4, multiplier: 'k2' },
					{ name: 'Пересчет товара – инвентаризация', unit: 'шт', basePrice: 4, multiplier: 'k3' },
					{ name: 'Снятие + утилизация деревянной обрешетки (короб)', unit: 'шт', basePrice: 200, multiplier: 'k2' },
					{ name: 'Снятие + утилизация деревянной обрешетки (паллета)', unit: 'шт', basePrice: 1500, multiplier: 'k1' },
				],
				services3: [
					{ name: 'Наклейка термотрансферного штрихкода c описанием товара 58х40 мм', unit: 'шт', basePrice: 5, multiplier: 'k3' },
					{ name: 'Все дополнительные наклейки (QR-код, спасибо за отзыв) размером до 58х80', unit: 'шт', basePrice: 6, multiplier: 'k3' },
					{ name: 'Наклейка термотрансферного штрихкода размером 90х150 мм', unit: 'шт', basePrice: 11, multiplier: 'k3' },
					{ name: 'Маркировка короба', unit: 'шт', basePrice: 6, multiplier: 'k2' },
					{ name: 'Маркировка паллеты', unit: 'шт', basePrice: 11, multiplier: 'k1' },
				],
				services4: [
					{ name: 'Визуальная проверка на брак', unit: 'шт', basePrice: 7, multiplier: 'k3' },
					{ name: 'Детальная проверка на брак', unit: 'шт', basePrice: 25, multiplier: 'k3' },
					{ name: 'Исправление дефектов при осмотре на брак', unit: 'шт', basePrice: 5, multiplier: 'k3' },
					{ name: 'Проверить комплектацию', unit: 'шт', basePrice: 5, multiplier: 'k3' },
					{ name: 'Замерить габариты упаковки', unit: 'шт', basePrice: 80, multiplier: 'k3' },
					{ name: 'Замерить габариты товара', unit: 'шт', basePrice: 200, multiplier: 'k3' },
				],
				services5: [
					{ name: '1 паллето-место', unit: 'сутки', basePrice: 70, multiplier: 'k1', hasDaysField: true },
					{ name: '1 короб 60×40×40', unit: 'сутки', basePrice: 30, multiplier: 'k2', hasDaysField: true, freeDays: 7 },
					{ name: 'Формирование коробов для хранения', unit: 'шт', basePrice: 50, multiplier: 'k2' }
				],
				services6: {
					'Упаковка товара в воздушно-пузырьковую плёнку': {
						subtitle: 'Размер товара',
						items: [
							{ name: '10см×10см×10см', unit: 'шт', basePrice: 15, multiplier: 'k3' },
							{ name: '20см×20см×20см', unit: 'шт', basePrice: 20, multiplier: 'k3' },
							{ name: '30см×30см×30см', unit: 'шт', basePrice: 30, multiplier: 'k3' },
							{ name: '50см×50см×50см', unit: 'шт', basePrice: 35, multiplier: 'k3' }
						]
					},
					'Упаковка в рукав ПВД/ПНД': {
						subtitle: 'Размеры товара',
						items: [
							{ name: '10см×10см×10см', unit: 'шт', basePrice: 15, multiplier: 'k3' },
							{ name: '20см×20см×20см', unit: 'шт', basePrice: 20, multiplier: 'k3' },
							{ name: '30см×30см×30см', unit: 'шт', basePrice: 30, multiplier: 'k3' },
							{ name: '50см×50см×50см', unit: 'шт', basePrice: 35, multiplier: 'k3' }
						]
					},
					'Упаковка в термоусадочную пленку': {
						subtitle: 'Размеры товара',
						items: [
							{ name: '10см×10см×10см', unit: 'шт', basePrice: 15, multiplier: 'k3' },
							{ name: '20см×20см×20см', unit: 'шт', basePrice: 20, multiplier: 'k3' },
							{ name: '30см×30см×30см', unit: 'шт', basePrice: 30, multiplier: 'k3' },
							{ name: '50см×50см×50см', unit: 'шт', basePrice: 35, multiplier: 'k3' }
						]
					},
					'Зип-пакет с бегунком': {
						subtitle: 'Размер пакета',
						items: [
							{ name: '15см×20см', unit: 'шт', basePrice: 8, multiplier: 'k3' },
							{ name: '20см×25см', unit: 'шт', basePrice: 9, multiplier: 'k3' },
							{ name: '20см×30см', unit: 'шт', basePrice: 10, multiplier: 'k3' },
							{ name: '25см×30см', unit: 'шт', basePrice: 11, multiplier: 'k3' },
							{ name: '25см×35см', unit: 'шт', basePrice: 12, multiplier: 'k3' },
							{ name: '30см×40см', unit: 'шт', basePrice: 13, multiplier: 'k3' },
							{ name: '35см×45см', unit: 'шт', basePrice: 14, multiplier: 'k3' },
							{ name: '40см×60см', unit: 'шт', basePrice: 16, multiplier: 'k3' },
							{ name: '50×60см', unit: 'шт', basePrice: 20, multiplier: 'k3' }
						]
					}
					,
					'Коробки': {
						subtitle: 'Тип коробки',
						items: [
							{ name: 'Коробка 40см×40см×35см', unit: 'шт', basePrice: 175, multiplier: 'custom', customLabel: 'кол-во' },
							{ name: 'Коробка 56см×54см×34см', unit: 'шт', basePrice: 195, multiplier: 'custom', customLabel: 'кол-во' },
							{ name: 'Коробка 60см×40см×40см', unit: 'шт', basePrice: 220, multiplier: 'custom', customLabel: 'кол-во' }
						]
					}
				},
				services7: [
					{ name: 'Обработка, сборка, упаковка, стикеровка заказа для схемы FBS', unit: 'заказ', basePrice: 35, multiplier: 'custom', customLabel: 'кол-во заказов' },
					{ name: 'Сборка общего короба', unit: 'шт', basePrice: 50, multiplier: 'custom', customLabel: 'кол-во коробов' },
					{ name: 'Отгрузка на ПВЗ в рекомендуемое время', unit: 'отгрузка', basePrice: 300, multiplier: 'custom', customLabel: 'кол-во отгрузок' }
				],
				services8: [
					{ name: 'Услуги грузчика (доп. работы)', unit: 'час', basePrice: 650, multiplier: 'custom', customLabel: 'кол-во часов' },
					{ name: 'Автобус до 500кг <span style="font-size: 12px; color: #666;">(тариф по городу, за пределами обсуждается индивидуально)</span>', exportName: 'Автобус до 500кг (тариф по городу, за пределами обсуждается индивидуально)', unit: 'час', basePrice: 900, multiplier: 'custom', customLabel: 'кол-во часов' },
					{ name: 'Грузовик до 2т <span style="font-size: 12px; color: #666;">(тариф по городу, за пределами обсуждается индивидуально)</span>', exportName: 'Грузовик до 2т (тариф по городу, за пределами обсуждается индивидуально)', unit: 'час', basePrice: 1700, multiplier: 'custom', customLabel: 'кол-во часов' },
					{ name: 'Грузовик до 3т <span style="font-size: 12px; color: #666;">(тариф по городу, за пределами обсуждается индивидуально)</span>', exportName: 'Грузовик до 3т (тариф по городу, за пределами обсуждается индивидуально)', unit: 'час', basePrice: 2200, multiplier: 'custom', customLabel: 'кол-во часов' },
					{ name: 'Грузовик до 5т <span style="font-size: 12px; color: #666;">(тариф по городу, за пределами обсуждается индивидуально)</span>', exportName: 'Грузовик до 5т (тариф по городу, за пределами обсуждается индивидуально)', unit: 'час', basePrice: 3000, multiplier: 'custom', customLabel: 'кол-во часов' },
					{ name: 'Грузовик до 10т <span style="font-size: 12px; color: #666;">(тариф по городу, за пределами обсуждается индивидуально)</span>', exportName: 'Грузовик до 10т (тариф по городу, за пределами обсуждается индивидуально)', unit: 'час', basePrice: 4000, multiplier: 'custom', customLabel: 'кол-во часов' },
					{ name: 'Доставка и сдача груза в ТК', unit: 'услуга', basePrice: 1300, multiplier: 'custom', customLabel: 'кол-во' }
				],
				computeLine: (row) => {
					// row: { name, unit, price, qty }
					const base = Math.max(0, Number(row.price || 0));
					const qtyNum = Math.max(0, Number(row.qty || 0));
					return base * qtyNum;
				},
				computeTotals: ({ items, discount, vat, context }) => {
					// items: массив { total }
					// discount/vat: проценты 0..100
					const subtotal = items.reduce((a, r) => a + r.total, 0);
					const discountAmount = Math.round(subtotal * (Math.min(Math.max(discount, 0), 100) / 100) * 100) / 100;
					const taxable = Math.max(subtotal - discountAmount, 0);
					
					// НДС уже включен в сумму, поэтому извлекаем его
					let vatAmount = 0;
					let grand = taxable;
					if (vat > 0) {
						const amountWithoutVat = Math.round(taxable / (1 + vat / 100) * 100) / 100;
						vatAmount = Math.round((taxable - amountWithoutVat) * 100) / 100;
						grand = taxable; // Итоговая сумма остается с НДС
					}
					
					return { subtotal, discountAmount, vatAmount, grand };
				},
			};

			const servicesListEl = document.getElementById('servicesList');
			const servicesListEl2 = document.getElementById('servicesList2');
			const servicesListEl3 = document.getElementById('servicesList3');
		const servicesListEl4 = document.getElementById('servicesList4');
		const servicesListEl5 = document.getElementById('servicesList5');
			const servicesListEl9 = document.getElementById('servicesList9');
		const currencyEl = null; // Убрано - всегда рубли
		const schemeEl = null; // Убрано - больше не нужно
		const k1El = document.getElementById('k1');
		const k2El = document.getElementById('k2');
		const k3El = document.getElementById('k3');
		const discountEl = document.getElementById('discount');
			const vatEl = document.getElementById('vat');
			const noteEl = document.getElementById('note');
			const subtotalEl = document.getElementById('subtotal');
			const discountAmountEl = document.getElementById('discountAmount');
			const vatAmountEl = document.getElementById('vatAmount');
			const grandTotalEl = document.getElementById('grandTotal');
			const resetBtn = document.getElementById('resetAll');
			const generatePricePDFBtn = document.getElementById('generatePricePDF');
			const generatePriceXLSBtn = document.getElementById('generatePriceXLS');
			const generateOrderXLSBtn = document.getElementById('generateOrderXLS');

			function numberOrZero(value) {
				const n = Number(value);
				return Number.isFinite(n) ? n : 0;
			}

			function formatter() {
				return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 });
			}

			function priceFormatter() {
				return new Intl.NumberFormat('ru-RU', { 
					minimumFractionDigits: 1,
					maximumFractionDigits: 1
				});
			}

			function serviceTemplate(service, index) {
				// Определяем подпись в зависимости от множителя
				let qtyLabel = 'кол-во';
				if (service.multiplier === 'k1') qtyLabel = 'кол-во паллет';
				else if (service.multiplier === 'k2') qtyLabel = 'кол-во коробов';
				else if (service.multiplier === 'k3') qtyLabel = 'кол-во товаров';
				else if (service.multiplier === 'custom') qtyLabel = service.customLabel || 'кол-во';
				
				const daysInput = service.hasDaysField ? 
					`<div style="display:flex; flex-direction:column; align-items:center; margin-left:8px;">
						<div style="font-size:10px; color: var(--muted); margin-bottom:2px;">кол-во дней</div>
						<input type="number" id="service_days_${index}" class="service-days" min="0" step="1" value="0" style="width:80px;" title="Количество дней">
					</div>` : '';
				
				return `
				<div class="service-item">
					<input type="checkbox" id="service_${index}" class="service-checkbox">
					<div style="flex:1">
						<div style="font-weight:600; margin-bottom:4px">${service.name}</div>
						<div class="service-price" data-index="${index}" style="color: var(--muted); font-size:12px"></div>
					</div>
					<div style="display:flex; align-items:flex-end; gap:6px;">
						<div style="display:flex; flex-direction:column; align-items:center;">
							<div style="font-size:10px; color: var(--muted); margin-bottom:2px;">${qtyLabel}</div>
							<div style="display:flex; align-items:center; gap:6px;">
							<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="-1" data-target="service_qty_${index}">−</button>
							<input type="number" id="service_qty_${index}" class="service-qty" min="0" step="1" value="0" style="width:80px;" title="Количество">
							<button type="button" class="secondary inc-btn" style="padding:6px 10px" data-inc="1" data-target="service_qty_${index}">+</button>
							</div>
						</div>
						${daysInput}
					</div>
					<div class="service-total" style="font-weight:700; min-width:120px; text-align:right">—</div>
				</div>`;
			}

			function renderSubBlock(subBlockName, subtitle, items, blockIndex) {
				const itemsHtml = items.map((item, itemIndex) => {
					const globalIndex = `6_${blockIndex}_${itemIndex}`;
					return serviceTemplate(item, globalIndex);
				}).join('');
				
				return `
					<div style="margin: 12px 0; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-2);">
						<div class="section-header" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; cursor:pointer" onclick="toggleSection('subblock_6_${blockIndex}')">
							<div style="font-weight:600; color: var(--text); font-size:14px">${subBlockName}</div>
							<div class="toggle-icon" style="font-size:16px; transition:transform 0.2s ease">▼</div>
						</div>
						<div id="subblock_6_${blockIndex}" class="collapsible-content" style="display:none">
							<div style="color: var(--muted); font-size:12px; margin-bottom:8px;">${subtitle}</div>
							${itemsHtml}
						</div>
					</div>
				`;
			}

			function renderServices() {
				servicesListEl.innerHTML = CONFIG.services.map((service, index) => serviceTemplate(service, index)).join('');
				wireServices();
				updateServicePriceLabels();
				if (servicesListEl2) {
					servicesListEl2.innerHTML = CONFIG.services2.map((service, index) => serviceTemplate(service, `2_${index}`)).join('');
					wireServices(true);
					updateServicePriceLabels(true);
				}
				if (servicesListEl3) {
					servicesListEl3.innerHTML = CONFIG.services3.map((service, index) => serviceTemplate(service, `3_${index}`)).join('');
					wireServices(false, true);
					updateServicePriceLabels(false, true);
				}
				if (servicesListEl4) {
					servicesListEl4.innerHTML = CONFIG.services4.map((service, index) => serviceTemplate(service, `4_${index}`)).join('');
					wireServices(false, false, true);
					updateServicePriceLabels(false, false, true);
				}
				if (servicesListEl5) {
					servicesListEl5.innerHTML = CONFIG.services5.map((service, index) => serviceTemplate(service, `5_${index}`)).join('');
					wireServices(false, false, false, true, false, false);
					updateServicePriceLabels(false, false, false, true, false, false);
					// Небольшая задержка для рендеринга DOM
					setTimeout(() => {
						updateServicePriceLabels5();
					}, 10);
				}
				const servicesListEl6 = document.getElementById('servicesList6');
				if (servicesListEl6) {
					const subBlocksHtml = Object.keys(CONFIG.services6).map((subBlockName, blockIndex) => {
						const subBlock = CONFIG.services6[subBlockName];
						return renderSubBlock(subBlockName, subBlock.subtitle, subBlock.items, blockIndex);
					}).join('');
					servicesListEl6.innerHTML = subBlocksHtml;
					// Небольшая задержка для рендеринга DOM
					setTimeout(() => {
						wireServices6();
						updateServicePriceLabels6();
					}, 10);
				}
				const servicesListEl7 = document.getElementById('servicesList7');
				if (servicesListEl7) {
					const services7Html = CONFIG.services7.map((service, index) => serviceTemplate(service, `7_${index}`)).join('');
					servicesListEl7.innerHTML = services7Html;
					// Небольшая задержка для рендеринга DOM
					setTimeout(() => {
						wireServices7();
						updateServicePriceLabels7();
					}, 10);
				}
				const servicesListEl8 = document.getElementById('servicesList8');
				if (servicesListEl8) {
					const services8Html = CONFIG.services8.map((service, index) => serviceTemplate(service, `8_${index}`)).join('');
					servicesListEl8.innerHTML = services8Html;
					// Небольшая задержка для рендеринга DOM
					setTimeout(() => {
						wireServices8();
						updateServicePriceLabels8();
					}, 10);
				}
				const servicesListEl9Local = document.getElementById('servicesList9');
				if (servicesListEl9Local) {
					const services9Html = CONFIG.services9.map((service, index) => serviceTemplate(service, `9_${index}`)).join('');
					servicesListEl9Local.innerHTML = services9Html;
					setTimeout(() => {
						wireServices9();
						updateServicePriceLabels9();
					}, 10);
				}
			}

			function updateServicePriceLabels(isSecond = false, isThird = false, isFourth = false, isFifth = false, isSixth = false, isSeventh = false) {
				// Для services6 (объект) используем отдельную функцию
				if (isSixth) {
					updateServicePriceLabels6();
					return;
				}
				
				// Для services7 используем отдельную функцию
				if (isSeventh) {
					updateServicePriceLabels7();
					return;
				}
				
				// Для services5 используем отдельную функцию
				if (isFifth) {
					updateServicePriceLabels5();
					return;
				}
				
				const list = isFourth ? CONFIG.services4 : (isThird ? CONFIG.services3 : (isSecond ? CONFIG.services2 : CONFIG.services));
				const root = isFourth ? servicesListEl4 : (isThird ? servicesListEl3 : (isSecond ? servicesListEl2 : servicesListEl));
				list.forEach((service, index) => {
					const idx = isFourth ? `4_${index}` : (isThird ? `3_${index}` : (isSecond ? `2_${index}` : index));
					const label = root.querySelector(`.service-price[data-index="${idx}"]`);
					if (label) {
						label.textContent = `${priceFormatter().format(service.basePrice)} ₽ / ${service.unit}`;
					}
				});
			}

			function updateServicePriceLabels7() {
				CONFIG.services7.forEach((service, index) => {
					const idx = `7_${index}`;
					const label = document.querySelector(`.service-price[data-index="${idx}"]`);
					if (label) {
						label.textContent = `${priceFormatter().format(service.basePrice)} ₽ / ${service.unit}`;
					}
				});
			}

			function updateServicePriceLabels8() {
				CONFIG.services8.forEach((service, index) => {
					const idx = `8_${index}`;
					const label = document.querySelector(`.service-price[data-index="${idx}"]`);
					if (label) {
						label.textContent = `${priceFormatter().format(service.basePrice)} ₽ / ${service.unit}`;
					}
				});
			}

			function updateServicePriceLabels9() {
				CONFIG.services9.forEach((service, index) => {
					const idx = `9_${index}`;
					const label = document.querySelector(`.service-price[data-index="${idx}"]`);
					if (label) {
						label.textContent = `${priceFormatter().format(service.basePrice)} ₽ / ${service.unit}`;
					}
				});
			}

			function updateServicePriceLabels5() {
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const label = document.querySelector(`.service-price[data-index="${idx}"]`);
					if (label) {
						label.textContent = `${priceFormatter().format(service.basePrice)} ₽ / ${service.unit}`;
					}
				});
			}

			function wireServices(isSecond = false, isThird = false, isFourth = false, isFifth = false, isSixth = false, isSeventh = false) {
				// Для services6 (объект) используем отдельную функцию
				if (isSixth) {
					wireServices6();
					return;
				}
				
				// Для services7 используем отдельную функцию
				if (isSeventh) {
					wireServices7();
					return;
				}
				
				// Для services5 используем отдельную функцию
				if (isFifth) {
					wireServices5();
					return;
				}
				
				const list = isFifth ? CONFIG.services5 : (isFourth ? CONFIG.services4 : (isThird ? CONFIG.services3 : (isSecond ? CONFIG.services2 : CONFIG.services)));
				list.forEach((service, index) => {
					const idx = isFifth ? `5_${index}` : (isFourth ? `4_${index}` : (isThird ? `3_${index}` : (isSecond ? `2_${index}` : index)));
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) {
						checkbox.addEventListener('change', () => { window.calculateTotals(); });
					}
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (qtyInput) {
						qtyInput.addEventListener('input', () => { window.calculateTotals(); });
						qtyInput.addEventListener('change', () => { window.calculateTotals(); });
					}
					const daysInput = document.getElementById(`service_days_${idx}`);
					if (daysInput) {
						daysInput.addEventListener('input', () => { window.calculateTotals(); });
						daysInput.addEventListener('change', () => { window.calculateTotals(); });
					}
				});
			}

			function wireServices5() {
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) {
						checkbox.addEventListener('change', () => { window.calculateTotals(); });
					}
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (qtyInput) {
						qtyInput.addEventListener('input', () => { window.calculateTotals(); });
						qtyInput.addEventListener('change', () => { window.calculateTotals(); });
					}
					const daysInput = document.getElementById(`service_days_${idx}`);
					if (daysInput) {
						daysInput.addEventListener('input', () => { window.calculateTotals(); });
						daysInput.addEventListener('change', () => { window.calculateTotals(); });
					}
				});
			}

			function wireServices7() {
				CONFIG.services7.forEach((service, index) => {
					const idx = `7_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) {
						checkbox.addEventListener('change', () => { window.calculateTotals(); });
					}
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (qtyInput) {
						qtyInput.addEventListener('input', () => { window.calculateTotals(); });
						qtyInput.addEventListener('change', () => { window.calculateTotals(); });
					}
				});
			}

			function wireServices8() {
				CONFIG.services8.forEach((service, index) => {
					const idx = `8_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) {
						checkbox.addEventListener('change', () => { window.calculateTotals(); });
					}
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (qtyInput) {
						qtyInput.addEventListener('input', () => { window.calculateTotals(); });
						qtyInput.addEventListener('change', () => { window.calculateTotals(); });
					}
				});
			}

			function wireServices9() {
				CONFIG.services9.forEach((service, index) => {
					const idx = `9_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) {
						checkbox.addEventListener('change', () => { window.calculateTotals(); });
					}
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (qtyInput) {
						qtyInput.addEventListener('input', () => { window.calculateTotals(); });
					}
				});
			}

			function wireServices6() {
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					subBlock.items.forEach((service, itemIndex) => {
						const idx = `6_${blockIndex}_${itemIndex}`;
						const checkbox = document.getElementById(`service_${idx}`);
						if (checkbox) {
							checkbox.addEventListener('change', () => { window.calculateTotals(); });
						}
						const qtyInput = document.getElementById(`service_qty_${idx}`);
						if (qtyInput) {
							qtyInput.addEventListener('input', () => { window.calculateTotals(); });
						}
					});
				});
			}

			function updateServicePriceLabels6() {
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					subBlock.items.forEach((service, itemIndex) => {
						const idx = `6_${blockIndex}_${itemIndex}`;
						const label = document.querySelector(`.service-price[data-index="${idx}"]`);
						if (label) {
							label.textContent = `${priceFormatter().format(service.basePrice)} ₽ / ${service.unit}`;
						}
					});
				});
			}

			window.syncQuantitiesFromContext = function() {
				const ctx = getContext();
				CONFIG.services.forEach((service, index) => {
					const qtyInput = document.getElementById(`service_qty_${index}`);
					if (!qtyInput) return;
					if (service.multiplier === 'k1') qtyInput.value = String(ctx.k1 || 0);
					if (service.multiplier === 'k2') qtyInput.value = String(ctx.k2 || 0);
					if (service.multiplier === 'k3') qtyInput.value = String(ctx.k3 || 0);
				});
				CONFIG.services2.forEach((service, index) => {
					const qtyInput = document.getElementById(`service_qty_2_${index}`);
					if (!qtyInput) return;
					if (service.multiplier === 'k1') qtyInput.value = String(ctx.k1 || 0);
					if (service.multiplier === 'k2') qtyInput.value = String(ctx.k2 || 0);
					if (service.multiplier === 'k3') qtyInput.value = String(ctx.k3 || 0);
				});
				CONFIG.services3.forEach((service, index) => {
					const qtyInput = document.getElementById(`service_qty_3_${index}`);
					if (!qtyInput) return;
					if (service.multiplier === 'k1') qtyInput.value = String(ctx.k1 || 0);
					if (service.multiplier === 'k2') qtyInput.value = String(ctx.k2 || 0);
					if (service.multiplier === 'k3') qtyInput.value = String(ctx.k3 || 0);
				});
				CONFIG.services4.forEach((service, index) => {
					const qtyInput = document.getElementById(`service_qty_4_${index}`);
					if (!qtyInput) return;
					if (service.multiplier === 'k1') qtyInput.value = String(ctx.k1 || 0);
					if (service.multiplier === 'k2') qtyInput.value = String(ctx.k2 || 0);
					if (service.multiplier === 'k3') qtyInput.value = String(ctx.k3 || 0);
				});
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (!qtyInput) return;
					if (service.multiplier === 'k1') qtyInput.value = String(ctx.k1 || 0);
					if (service.multiplier === 'k2') qtyInput.value = String(ctx.k2 || 0);
					if (service.multiplier === 'k3') qtyInput.value = String(ctx.k3 || 0);
					// Для услуг хранения количество дней остается 0 по умолчанию
					if (service.hasDaysField) {
						const daysInput = document.getElementById(`service_days_${idx}`);
						if (daysInput && daysInput.value === '0') {
							daysInput.value = '0';
						}
					}
				});
			// Services6
			Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
				const subBlock = CONFIG.services6[subBlockName];
				const shouldSyncFromK3 = subBlockName !== 'Коробки';
				subBlock.items.forEach((service, itemIndex) => {
					const qtyInput = document.getElementById(`service_qty_6_${blockIndex}_${itemIndex}`);
					if (!qtyInput) return;
					if (shouldSyncFromK3) {
						qtyInput.value = String(ctx.k3 || 0);
					} else {
						// Для подраздела "Коробки" всегда держим 0 по умолчанию
						if (qtyInput.value === '' || qtyInput.value === '0') qtyInput.value = '0';
					}
				});
			});
				// Services7 - custom поля, не автозаполняются
			};

			function getContext() {
				return {
					k1: numberOrZero(k1El ? k1El.value : 0),
					k2: numberOrZero(k2El ? k2El.value : 0),
					k3: numberOrZero(k3El ? k3El.value : 0),
				};
			}

			function readSelectedServices() {
				const data = [];
				CONFIG.services.forEach((service, index) => {
					const checkbox = document.getElementById(`service_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				CONFIG.services2.forEach((service, index) => {
					const checkbox = document.getElementById(`service_2_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_2_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				CONFIG.services3.forEach((service, index) => {
					const checkbox = document.getElementById(`service_3_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_3_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				CONFIG.services4.forEach((service, index) => {
					const checkbox = document.getElementById(`service_4_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_4_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_${idx}`);
						const daysInput = document.getElementById(`service_days_${idx}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const days = numberOrZero(daysInput ? daysInput.value : 0);
						
						let total = 0;
						if (service.hasDaysField) {
							// Особые правила для хранения
							if (service.freeDays) {
								// Для коробов: бесплатно 7 дней, потом 30р/сутки
								const paidDays = Math.max(0, days - service.freeDays);
								total = qty * paidDays * service.basePrice;
							} else {
								// Для паллет: 70р/паллет/сутки
								total = qty * days * service.basePrice;
							}
						} else {
							// Обычный расчет для формирования коробов
							total = CONFIG.computeLine({ 
								name: service.name, 
								price: service.basePrice, 
								qty, 
								unit: service.unit, 
								context: getContext() 
							});
						}
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				// Services6
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					subBlock.items.forEach((service, itemIndex) => {
						const checkbox = document.getElementById(`service_6_${blockIndex}_${itemIndex}`);
						if (checkbox && checkbox.checked) {
							const qtyInput = document.getElementById(`service_qty_6_${blockIndex}_${itemIndex}`);
							const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
							const total = CONFIG.computeLine({ 
								name: service.name, 
								price: service.basePrice, 
								qty, 
								unit: service.unit, 
								context: getContext() 
							});
							data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
						}
					});
				});
				// Services7
				CONFIG.services7.forEach((service, index) => {
					const checkbox = document.getElementById(`service_7_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_7_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				// Services8
				CONFIG.services8.forEach((service, index) => {
					const checkbox = document.getElementById(`service_8_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_8_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				// Services9
				CONFIG.services9.forEach((service, index) => {
					const checkbox = document.getElementById(`service_9_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_9_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, price: service.basePrice, qty, unit: service.unit, context: getContext() 
						});
						data.push({ name: service.name, price: service.basePrice, qty, unit: service.unit, total });
					}
				});
				return data;
			}

			window.calculateTotals = function() {
				const items = readSelectedServices();
				const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
				const vat = Math.min(Math.max(numberOrZero(vatEl.value), 0), 100);
				const { subtotal, discountAmount, vatAmount, grand } = CONFIG.computeTotals({ items, discount, vat, context: getContext() });
				updateServicePriceLabels();
				updateServicePriceLabels(true);
				updateServicePriceLabels(false, true);
				updateServicePriceLabels(false, false, true);
				updateServicePriceLabels(false, false, false, false, false, false, true);
				updateServicePriceLabels6();
				updateServicePriceLabels5();
				updateServicePriceLabels7();
				updateServicePriceLabels8();
				updateServicePriceLabels9();

				// Update service totals (always show price×qty, dim if not selected)
				CONFIG.services.forEach((service, index) => {
					const checkbox = document.getElementById(`service_${index}`);
					const totalEl = document.querySelector(`#service_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
				});
				CONFIG.services2.forEach((service, index) => {
					const checkbox = document.getElementById(`service_2_${index}`);
					const totalEl = document.querySelector(`#service_2_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_2_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
				});
				CONFIG.services3.forEach((service, index) => {
					const checkbox = document.getElementById(`service_3_${index}`);
					const totalEl = document.querySelector(`#service_3_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_3_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
				});
				CONFIG.services4.forEach((service, index) => {
					const checkbox = document.getElementById(`service_4_${index}`);
					const totalEl = document.querySelector(`#service_4_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_4_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
				});
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					const totalEl = document.querySelector(`#service_${idx}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					const daysInput = document.getElementById(`service_days_${idx}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const days = numberOrZero(daysInput ? daysInput.value : 0);
					
					let total = 0;
					if (service.hasDaysField) {
						// Особые правила для хранения
						if (service.freeDays) {
							// Для коробов: бесплатно 7 дней, потом 30р/сутки
							const paidDays = Math.max(0, days - service.freeDays);
							total = qty * paidDays * service.basePrice;
						} else {
							// Для паллет: 70р/паллет/сутки
							total = qty * days * service.basePrice;
						}
					} else {
						// Обычный расчет для формирования коробов
						total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
					}
					if (totalEl) {
						updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
					}
				});
				// Services6
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					subBlock.items.forEach((service, itemIndex) => {
						const checkbox = document.getElementById(`service_6_${blockIndex}_${itemIndex}`);
						const totalEl = document.querySelector(`#service_6_${blockIndex}_${itemIndex}`).closest('.service-item').querySelector('.service-total');
						const qtyInput = document.getElementById(`service_qty_6_${blockIndex}_${itemIndex}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
					});
				});
				// Services7
				CONFIG.services7.forEach((service, index) => {
					const checkbox = document.getElementById(`service_7_${index}`);
					const totalEl = document.querySelector(`#service_7_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_7_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
				});
				CONFIG.services8.forEach((service, index) => {
					const checkbox = document.getElementById(`service_8_${index}`);
					const totalEl = document.querySelector(`#service_8_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_8_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					if (totalEl) {
						updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
					}
				});
				// Services9
				CONFIG.services9.forEach((service, index) => {
					const checkbox = document.getElementById(`service_9_${index}`);
					const totalEl = document.querySelector(`#service_9_${index}`).closest('.service-item').querySelector('.service-total');
					const qtyInput = document.getElementById(`service_qty_9_${index}`);
					const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
					const total = CONFIG.computeLine({ 
						name: service.name, 
						price: service.basePrice, 
						qty, 
						unit: service.unit, 
						context: getContext() 
					});
					if (totalEl) {
						updateServiceTotalWithDiscount(totalEl, total, checkbox && checkbox.checked);
					}
				});

				subtotalEl.textContent = formatter().format(subtotal);
				discountAmountEl.textContent = `− ${formatter().format(discountAmount)}`;
				vatAmountEl.textContent = formatter().format(vatAmount);
				grandTotalEl.textContent = formatter().format(grand);

				// Обновляем плавающее окно с общей суммой
				const floatingTotalAmountEl = document.getElementById('floatingTotalAmount');
				if (floatingTotalAmountEl) {
					floatingTotalAmountEl.textContent = formatter().format(grand);
				}

				// Обновляем цены со скидкой
				updatePricesWithDiscount();
				
				// Обновляем суммы блоков
				updateBlockTotals();

				return { items, subtotal, discount, discountAmount, vat, vatAmount, grand };
			}

			function updateBlockTotalWithDiscount(elementId, total) {
				const element = document.getElementById(elementId);
				if (!element) return;
				
				const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
				const discountMultiplier = (100 - discount) / 100;
				const discountedTotal = Math.round(total * discountMultiplier * 100) / 100;
				
				if (discount > 0) {
					element.className = 'block-total-discounted';
					element.setAttribute('data-original-price', formatter().format(total));
					element.setAttribute('data-discounted-price', formatter().format(discountedTotal));
					element.textContent = '';
				} else {
					element.className = '';
					element.removeAttribute('data-original-price');
					element.removeAttribute('data-discounted-price');
					element.textContent = formatter().format(total);
				}
			}

			function updateBlockTotals() {
				// Блок 1 - Приёмка/Отгрузка товара
				let block1Total = 0;
				CONFIG.services.forEach((service, index) => {
					const checkbox = document.getElementById(`service_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block1Total += total;
					}
				});
				const blockTotal1El = document.getElementById('blockTotal1');
				updateBlockTotalWithDiscount('blockTotal1', block1Total);

				// Блок 2 - Действия с товаром
				let block2Total = 0;
				CONFIG.services2.forEach((service, index) => {
					const checkbox = document.getElementById(`service_2_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_2_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block2Total += total;
					}
				});
				const blockTotal2El = document.getElementById('blockTotal2');
				updateBlockTotalWithDiscount('blockTotal2', block2Total);

				// Блок 3 - Стикеровка
				let block3Total = 0;
				CONFIG.services3.forEach((service, index) => {
					const checkbox = document.getElementById(`service_3_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_3_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block3Total += total;
					}
				});
				const blockTotal3El = document.getElementById('blockTotal3');
				updateBlockTotalWithDiscount('blockTotal3', block3Total);

				// Блок 4 - Проверка/обработка товара
				let block4Total = 0;
				CONFIG.services4.forEach((service, index) => {
					const checkbox = document.getElementById(`service_4_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_4_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block4Total += total;
					}
				});
				const blockTotal4El = document.getElementById('blockTotal4');
				updateBlockTotalWithDiscount('blockTotal4', block4Total);

				// Блок 5 - Хранение
				let block5Total = 0;
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_${idx}`);
						const daysInput = document.getElementById(`service_days_${idx}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const days = numberOrZero(daysInput ? daysInput.value : 0);
						
						let total = 0;
						if (service.hasDaysField) {
							if (service.freeDays) {
								const paidDays = Math.max(0, days - service.freeDays);
								total = qty * paidDays * service.basePrice;
							} else {
								total = qty * days * service.basePrice;
							}
						} else {
							total = CONFIG.computeLine({ 
								name: service.name, 
								price: service.basePrice, 
								qty, 
								unit: service.unit, 
								context: getContext() 
							});
						}
						block5Total += total;
					}
				});
				const blockTotal5El = document.getElementById('blockTotal5');
				updateBlockTotalWithDiscount('blockTotal5', block5Total);

				// Блок 6 - Дополнительная упаковка
				let block6Total = 0;
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					subBlock.items.forEach((service, itemIndex) => {
						const checkbox = document.getElementById(`service_6_${blockIndex}_${itemIndex}`);
						if (checkbox && checkbox.checked) {
							const qtyInput = document.getElementById(`service_qty_6_${blockIndex}_${itemIndex}`);
							const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
							const total = CONFIG.computeLine({ 
								name: service.name, 
								price: service.basePrice, 
								qty, 
								unit: service.unit, 
								context: getContext() 
							});
							block6Total += total;
						}
					});
				});
				const blockTotal6El = document.getElementById('blockTotal6');
				updateBlockTotalWithDiscount('blockTotal6', block6Total);

				// Блок 7 - FBS
				let block7Total = 0;
				CONFIG.services7.forEach((service, index) => {
					const checkbox = document.getElementById(`service_7_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_7_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block7Total += total;
					}
				});
				const blockTotal7El = document.getElementById('blockTotal7');
				updateBlockTotalWithDiscount('blockTotal7', block7Total);

				// Блок 8 - Дополнительные услуги
				let block8Total = 0;
				CONFIG.services8.forEach((service, index) => {
					const checkbox = document.getElementById(`service_8_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_8_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block8Total += total;
					}
				});
				const blockTotal8El = document.getElementById('blockTotal8');
				updateBlockTotalWithDiscount('blockTotal8', block8Total);

				// Блок 9 - Работа с личным кабинетом
				let block9Total = 0;
				CONFIG.services9.forEach((service, index) => {
					const checkbox = document.getElementById(`service_9_${index}`);
					if (checkbox && checkbox.checked) {
						const qtyInput = document.getElementById(`service_qty_9_${index}`);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						const total = CONFIG.computeLine({ 
							name: service.name, 
							price: service.basePrice, 
							qty, 
							unit: service.unit, 
							context: getContext() 
						});
						block9Total += total;
					}
				});
				updateBlockTotalWithDiscount('blockTotal9', block9Total);
			}

			function updatePricesWithDiscount() {
				const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
				const discountMultiplier = (100 - discount) / 100;
				
				// Обновляем цены услуг во всех блоках
				updateServicePricesWithDiscount(CONFIG.services, '');
				updateServicePricesWithDiscount(CONFIG.services2, '2_');
				updateServicePricesWithDiscount(CONFIG.services3, '3_');
				updateServicePricesWithDiscount(CONFIG.services4, '4_');
				updateServicePricesWithDiscount(CONFIG.services5, '5_');
				updateServicePricesWithDiscount(CONFIG.services7, '7_');
				updateServicePricesWithDiscount(CONFIG.services8, '8_');
				updateServicePricesWithDiscount(CONFIG.services9, '9_');
				
				// Services6 (объект)
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					updateServicePricesWithDiscount(subBlock.items, `6_${blockIndex}_`);
				});
			}

			function updateServicePricesWithDiscount(services, prefix) {
				const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
				const discountMultiplier = (100 - discount) / 100;
				
				services.forEach((service, index) => {
					const idx = prefix + index;
					const label = document.querySelector(`.service-price[data-index="${idx}"]`);
					if (label) {
						const originalPrice = service.basePrice;
						const discountedPrice = Math.round(originalPrice * discountMultiplier * 100) / 100;
						
						if (discount > 0) {
							label.className = 'service-price service-price-discounted';
							label.setAttribute('data-original-price', `${priceFormatter().format(originalPrice)} ₽ / ${service.unit}`);
							label.setAttribute('data-discounted-price', `${priceFormatter().format(discountedPrice)} ₽ / ${service.unit}`);
							label.textContent = ''; // Очищаем текст, так как используем ::before и ::after
						} else {
							label.className = 'service-price';
							label.removeAttribute('data-original-price');
							label.removeAttribute('data-discounted-price');
							label.textContent = `${priceFormatter().format(originalPrice)} ₽ / ${service.unit}`;
						}
					}
				});
			}

			function updateServiceTotalWithDiscount(totalEl, total, isChecked = true) {
				if (!totalEl) return;
				
				const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
				const discountMultiplier = (100 - discount) / 100;
				const discountedTotal = Math.round(total * discountMultiplier * 100) / 100;
				
				// Устанавливаем opacity в зависимости от того, выбрана ли услуга
				totalEl.style.opacity = isChecked ? '1' : '.6';
				
				if (discount > 0) {
					totalEl.className = 'service-total service-total-discounted';
					totalEl.setAttribute('data-original-price', formatter().format(total));
					totalEl.setAttribute('data-discounted-price', formatter().format(discountedTotal));
					totalEl.textContent = '';
				} else {
					totalEl.className = 'service-total';
					totalEl.removeAttribute('data-original-price');
					totalEl.removeAttribute('data-discounted-price');
					totalEl.textContent = formatter().format(total);
				}
			}

			// Удобные кнопки +/- для количества
			window.incrementQty = function(idx, delta) {
				const input = document.getElementById(`service_qty_${idx}`);
				if (!input) return;
				const next = Math.max(0, numberOrZero(input.value) + delta);
				input.value = String(next);
				if (typeof window.calculateTotals === 'function') {
					window.calculateTotals();
					saveToStorage();
				}
			}

			// +/- для верхних полей K1/K2/K3
			window.incrementField = function(fieldId, delta) {
				const input = document.getElementById(fieldId);
				if (!input) return;
				const next = Math.max(0, numberOrZero(input.value) + delta);
				input.value = String(next);
				// Синхронизуем количества услуг, зависящие от K1/K2/K3
				if (typeof syncQuantitiesFromContext === 'function') {
					syncQuantitiesFromContext();
				}
				if (typeof window.calculateTotals === 'function') {
					window.calculateTotals();
					saveToStorage();
				}
			}

			// Делегирование кликов/тачей по кнопкам +/- (устойчиво в iOS)
			document.addEventListener('click', function(e) {
				const btn = e.target.closest && e.target.closest('.inc-btn');
				if (!btn) return;
				e.preventDefault();
				const targetId = btn.getAttribute('data-target');
				const delta = Number(btn.getAttribute('data-inc') || 0);
				if (!targetId || !Number.isFinite(delta)) return;
				const input = document.getElementById(targetId);
				if (!input) return;
				const next = Math.max(0, numberOrZero(input.value) + delta);
				input.value = String(next);
				// Для верхних полей синхронизируем зависимости
				if (targetId === 'k1' || targetId === 'k2' || targetId === 'k3') {
					if (typeof syncQuantitiesFromContext === 'function') syncQuantitiesFromContext();
				}
				if (typeof window.calculateTotals === 'function') {
					window.calculateTotals();
					saveToStorage();
				}
			}, { passive: false });

			document.addEventListener('touchend', function(e) {
				const btn = e.target.closest && e.target.closest('.inc-btn');
				if (!btn) return;
				e.preventDefault();
				btn.click();
			}, { passive: false });

			function generatePricePDF() {
				// Создаем HTML шаблон для PDF
				const pdfContent = createPDFTemplate();
				
				// Создаем или обновляем элемент для печати
				let printDiv = document.getElementById('print-content');
				if (printDiv) {
					printDiv.remove();
				}
				
				printDiv = document.createElement('div');
				printDiv.id = 'print-content';
				printDiv.innerHTML = pdfContent;
				document.body.appendChild(printDiv);
				
				// Запускаем печать
				window.print();
				
				// Удаляем элемент после печати
				setTimeout(() => {
					if (printDiv && printDiv.parentNode) {
						printDiv.parentNode.removeChild(printDiv);
					}
				}, 1000);
			}

			function generatePriceXLS() {
			// Создаем данные для XLSX
			const xlsData = createXLSTemplate();
			// Создаем и скачиваем настоящий .xlsx с оформлением и фильтрами
			downloadAOA_XLSX(xlsData, `Прайс_фулфилмент_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '_')}.xlsx`, 'ПРАЙС УСЛУГ ФУЛФИЛМЕНТА');
			}

			function generateOrderXLS() {
				// Создаем данные для заявки (только выбранные услуги)
				const orderData = createOrderTemplate();
				
			// Создаем и скачиваем нативный .xlsx с красивыми заголовками
			downloadXLSX(orderData, `Заявка_фулфилмент_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '_')}.xlsx`);
			}

			function createPDFTemplate() {
				let html = `
					<div style="font-family: Arial, sans-serif; padding: 20px; background: white; color: black; max-width: 800px; margin: 0 auto;">
						<!-- Заголовок -->
						<div style="text-align: center; margin-bottom: 30px;">
							<h1 style="font-size: 24px; margin: 0; color: black; font-weight: bold;">Высокотехнологичный фулфилмент во Владивостоке WB|Ozon</h1>
						</div>
						
						<!-- Информация о компании -->
						<div style="margin-bottom: 30px; text-align: center;">
							<p style="margin: 5px 0; font-size: 14px; font-weight: bold;">ИП Бардош Роман Евгеньевич</p>
							<p style="margin: 5px 0; font-size: 14px;">ИНН 251005851477</p>
							<p style="margin: 5px 0; font-size: 14px;">Номер для связи и заявок: 89532132582</p>
						</div>
						
						<!-- Линия разделения -->
						<hr style="border: 2px solid black; margin: 20px 0;">
						
						<!-- Заголовок прайса -->
						<h2 style="text-align: center; font-size: 20px; margin: 30px 0; color: black; font-weight: bold;">Прайс услуг фулфилмента</h2>
				`;
				
				// Функция для добавления блока услуг
				function addServiceBlock(blockTitle, services) {
					html += `
						<div style="margin-bottom: 30px; page-break-inside: avoid;">
							<h3 style="font-size: 16px; margin: 0 0 15px 0; color: black; border-bottom: 2px solid black; padding-bottom: 5px; font-weight: bold;">${blockTitle}</h3>
							<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
								<thead>
									<tr style="background-color: #f0f0f0;">
										<th style="border: 1px solid black; padding: 10px; text-align: left; font-size: 12px; font-weight: bold;">Услуга</th>
										<th style="border: 1px solid black; padding: 10px; text-align: center; font-size: 12px; width: 120px; font-weight: bold;">Цена</th>
										<th style="border: 1px solid black; padding: 10px; text-align: center; font-size: 12px; width: 100px; font-weight: bold;">Ед.</th>
									</tr>
								</thead>
								<tbody>
					`;
					
					services.forEach(service => {
						const serviceName = service.exportName || service.name;
						html += `
							<tr>
								<td style="border: 1px solid black; padding: 10px; font-size: 11px;">${serviceName}</td>
								<td style="border: 1px solid black; padding: 10px; text-align: center; font-size: 11px; font-weight: bold;">${service.basePrice} руб.</td>
								<td style="border: 1px solid black; padding: 10px; text-align: center; font-size: 11px;">${service.unit}</td>
							</tr>
						`;
					});
					
					html += `
								</tbody>
							</table>
						</div>
					`;
				}
				
				// Добавляем все блоки услуг
				addServiceBlock('1. Приёмка/Отгрузка товара', CONFIG.services);
				addServiceBlock('2. Действия с товаром', CONFIG.services2);
				addServiceBlock('3. Стикеровка', CONFIG.services3);
				addServiceBlock('4. Проверка/обработка товара', CONFIG.services4);
				addServiceBlock('5. Хранение', CONFIG.services5);
				
				// Блок 6 - Дополнительная упаковка (объект)
				html += `
					<div style="margin-bottom: 30px; page-break-inside: avoid;">
						<h3 style="font-size: 16px; margin: 0 0 15px 0; color: black; border-bottom: 2px solid black; padding-bottom: 5px; font-weight: bold;">6. Дополнительная упаковка</h3>
				`;
				
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					
					html += `
						<div style="margin-bottom: 20px;">
							<h4 style="font-size: 14px; margin: 0 0 10px 0; color: black; font-weight: bold;">6.${blockIndex + 1}. ${subBlockName}</h4>
							<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
								<thead>
									<tr style="background-color: #f5f5f5;">
										<th style="border: 1px solid black; padding: 8px; text-align: left; font-size: 11px; font-weight: bold;">Услуга</th>
										<th style="border: 1px solid black; padding: 8px; text-align: center; font-size: 11px; width: 120px; font-weight: bold;">Цена</th>
										<th style="border: 1px solid black; padding: 8px; text-align: center; font-size: 11px; width: 100px; font-weight: bold;">Ед.</th>
									</tr>
								</thead>
								<tbody>
					`;
					
					subBlock.items.forEach(service => {
						html += `
							<tr>
								<td style="border: 1px solid black; padding: 8px; font-size: 10px;">${service.name}</td>
								<td style="border: 1px solid black; padding: 8px; text-align: center; font-size: 10px; font-weight: bold;">${service.basePrice} руб.</td>
								<td style="border: 1px solid black; padding: 8px; text-align: center; font-size: 10px;">${service.unit}</td>
							</tr>
						`;
					});
					
					html += `
								</tbody>
							</table>
						</div>
					`;
				});
				
				html += `</div>`;
				
				// Блок 7 - FBS
				addServiceBlock('7. FBS', CONFIG.services7);
				
			// Блок 8 - Дополнительные услуги
			addServiceBlock('Дополнительные услуги', CONFIG.services8);
			// Блок 9 - Работа с личным кабинетом
			addServiceBlock('Работа с личным кабинетом', CONFIG.services9);
				
				// Футер
				html += `
					<div style="margin-top: 50px; text-align: center; font-size: 10px; color: black; border-top: 1px solid black; padding-top: 20px;">
						<p style="margin: 5px 0;">Данный прайс сформирован автоматически калькулятором услуг фулфилмента</p>
						<p style="margin: 5px 0; font-weight: bold;">ИП Бардош Роман Евгеньевич, ИНН 251005851477</p>
					</div>
				`;
				
				html += `</div>`;
				
				return html;
			}

			function createXLSTemplate() {
				const data = [];
				
				// Заголовок
				data.push(['Высокотехнологичный фулфилмент во Владивостоке WB|Ozon']);
				data.push(['']);
				data.push(['ИП Бардош Роман Евгеньевич']);
				data.push(['ИНН 251005851477']);
				data.push(['Номер для связи и заявок: 89532132582']);
				data.push(['']);
				data.push(['Прайс услуг фулфилмента']);
				data.push(['']);
				
				// Функция для добавления блока услуг
				function addServiceBlock(blockTitle, services) {
					data.push([blockTitle]);
					data.push(['Услуга', 'Цена', 'Ед.']);
					
					services.forEach(service => {
						const serviceName = service.exportName || service.name;
						data.push([serviceName, `${service.basePrice} руб.`, service.unit]);
					});
					
					data.push(['']);
				}
				
				// Добавляем все блоки услуг
				addServiceBlock('1. Приёмка/Отгрузка товара', CONFIG.services);
				addServiceBlock('2. Действия с товаром', CONFIG.services2);
				addServiceBlock('3. Стикеровка', CONFIG.services3);
				addServiceBlock('4. Проверка/обработка товара', CONFIG.services4);
				addServiceBlock('5. Хранение', CONFIG.services5);
				
				// Блок 6 - Дополнительная упаковка (объект)
				data.push(['6. Дополнительная упаковка']);
				data.push(['']);
				
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					
					data.push([`6.${blockIndex + 1}. ${subBlockName}`]);
					data.push(['Услуга', 'Цена', 'Ед.']);
					
					subBlock.items.forEach(service => {
						data.push([service.name, `${service.basePrice} руб.`, service.unit]);
					});
					
					data.push(['']);
				});
				
				// Блок 7 - FBS
				addServiceBlock('7. FBS', CONFIG.services7);
				
				// Блок 8 - Дополнительные услуги
				addServiceBlock('8. Дополнительные услуги', CONFIG.services8);
				
				// Блок 9 - Работа с личным кабинетом
				addServiceBlock('9. Работа с личным кабинетом', CONFIG.services9);
				
				// Футер
				data.push(['']);
				data.push(['Данный прайс сформирован автоматически калькулятором услуг фулфилмента']);
				data.push(['ИП Бардош Роман Евгеньевич, ИНН 251005851477']);
				
				return data;
			}

		function createOrderTemplate() {
			const data = [];
			
			// Информация о поставке
			const k1 = numberOrZero(k1El.value);
			const k2 = numberOrZero(k2El.value);
			const k3 = numberOrZero(k3El.value);
			
			// Заголовок таблицы услуг
			data.push(['Наименование услуги', 'Стоимость за ед. (₽)', 'Количество', 'Скидка %', 'Цена по скидке за ед. (₽)', 'НДС %', 'НДС сумма (₽)', 'Общая сумма (₽)']);
				
			let totalSelectedServices = 0;
			let totalDiscountAmount = 0;
			let totalVatAmount = 0;
			
			// Функция для добавления выбранных услуг из блока
			function addSelectedServices(services, prefix = '') {
				services.forEach((service, index) => {
					// Формируем правильный ID для чекбокса
					const checkboxId = prefix ? `service_${prefix}${index}` : `service_${index}`;
					const checkbox = document.getElementById(checkboxId);
					
					if (checkbox && checkbox.checked) {
						// Формируем правильные ID для полей ввода
						const qtyInputId = prefix ? `service_qty_${prefix}${index}` : `service_qty_${index}`;
						const qtyInput = document.getElementById(qtyInputId);
						const qty = numberOrZero(qtyInput ? qtyInput.value : 0);
						
						let serviceTotal = 0;
						
						if (service.hasDaysField) {
							const daysInputId = prefix ? `service_days_${prefix}${index}` : `service_days_${index}`;
							const daysInput = document.getElementById(daysInputId);
							const days = numberOrZero(daysInput ? daysInput.value : 0);
							
							if (service.freeDays) {
								const paidDays = Math.max(0, days - service.freeDays);
								serviceTotal = qty * paidDays * service.basePrice;
							} else {
								serviceTotal = qty * days * service.basePrice;
							}
						} else {
							serviceTotal = CONFIG.computeLine({ 
								name: service.name, 
								price: service.basePrice, 
								qty, 
								unit: service.unit, 
								context: getContext() 
							});
						}
						
						totalSelectedServices += serviceTotal;
						
						const serviceName = service.exportName || service.name;
						const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
						const vat = Math.min(Math.max(numberOrZero(vatEl.value), 0), 100);
						
						// Рассчитываем скидку
						const discountAmount = Math.round(serviceTotal * (discount / 100) * 100) / 100;
						const taxable = Math.max(serviceTotal - discountAmount, 0);
						totalDiscountAmount += discountAmount;
						
						// Рассчитываем НДС (НДС уже включен в сумму, поэтому извлекаем его)
						let vatAmount = 0;
						let finalTotal = taxable;
						if (vat > 0) {
							const amountWithoutVat = Math.round(taxable / (1 + vat / 100) * 100) / 100;
							vatAmount = Math.round((taxable - amountWithoutVat) * 100) / 100;
							finalTotal = taxable; // Итоговая сумма остается с НДС
						}
						totalVatAmount += vatAmount;
						
						// Рассчитываем цену по скидке за единицу
						const discountedPricePerUnit = discount > 0 ? 
							Math.round(service.basePrice * (100 - discount) / 100 * 100) / 100 : 
							service.basePrice;
						
						// Добавляем строку в таблицу
						data.push([
							serviceName,
							priceFormatter().format(service.basePrice),
							qty,
							discount > 0 ? `${discount}%` : '—',
							discount > 0 ? priceFormatter().format(discountedPricePerUnit) : '—',
							vat > 0 ? `${vat}%` : '—',
							vat > 0 ? formatter().format(vatAmount) : '—',
							formatter().format(finalTotal)
						]);
					}
				});
			}
				
			// Проверяем все блоки услуг
			addSelectedServices(CONFIG.services);
			addSelectedServices(CONFIG.services2, '2_');
			addSelectedServices(CONFIG.services3, '3_');
			addSelectedServices(CONFIG.services4, '4_');
			addSelectedServices(CONFIG.services5, '5_');
			addSelectedServices(CONFIG.services7, '7_');
			addSelectedServices(CONFIG.services8, '8_');
			addSelectedServices(CONFIG.services9, '9_');
			
			// Services6 (объект) - обрабатываем каждый подблок отдельно
			Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
				const subBlock = CONFIG.services6[subBlockName];
				addSelectedServices(subBlock.items, `6_${blockIndex}_`);
			});
			
			// Итоговая строка
			const discount = Math.min(Math.max(numberOrZero(discountEl.value), 0), 100);
			const vat = Math.min(Math.max(numberOrZero(vatEl.value), 0), 100);
			const taxable = Math.max(totalSelectedServices - totalDiscountAmount, 0);
			
			data.push(['']);
			data.push(['ИТОГО:', '', '', '', '', '', formatter().format(totalVatAmount), formatter().format(taxable)]);
				
				return data;
			}

			function downloadXLS(data, filename) {
				// Создаем HTML таблицу с красивым оформлением для XLS
				let html = `
					<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
					<head>
						<meta charset="utf-8">
						<!--[if gte mso 9]>
						<xml>
							<x:ExcelWorkbook>
								<x:ExcelWorksheets>
									<x:ExcelWorksheet>
										<x:Name>Прайс услуг</x:Name>
										<x:WorksheetOptions>
											<x:DefaultRowHeight>285</x:DefaultRowHeight>
										</x:WorksheetOptions>
									</x:ExcelWorksheet>
								</x:ExcelWorksheets>
							</x:ExcelWorkbook>
						</xml>
						<![endif]-->
						<style>
							table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
							.header { background-color: #4472C4; color: white; font-weight: bold; text-align: center; padding: 15px; font-size: 16px; }
							.company { background-color: #D9E2F3; padding: 10px; text-align: center; font-weight: bold; }
							.block-title { background-color: #8FAADC; color: white; font-weight: bold; padding: 12px; font-size: 14px; }
							.sub-block-title { background-color: #B4C6E7; color: #2F5597; font-weight: bold; padding: 10px; font-size: 13px; }
							.table-header { background-color: #D9E2F3; font-weight: bold; text-align: left; padding: 8px; border: 1px solid #000000; }
							.service-row:nth-child(even) { background-color: #F2F2F2; }
							.service-row:nth-child(odd) { background-color: white; }
							.service-cell { padding: 8px; border: 1px solid #4472C4; }
							.price-cell { text-align: center; font-weight: bold; color: #2F5597; }
							.unit-cell { text-align: center; }
							.footer { background-color: #E7E6E6; padding: 10px; text-align: center; font-style: italic; font-size: 11px; }
							.empty-row { height: 10px; }
						</style>
					</head>
					<body>
						<table>
				`;
				
				data.forEach((row, index) => {
					if (row.length === 1) {
						if (row[0] === '') {
							html += '<tr class="empty-row"><td colspan="3"></td></tr>';
						} else if (row[0].includes('Высокотехнологичный')) {
							html += `<tr><td colspan="3" class="header">${row[0]}</td></tr>`;
						} else if (row[0].includes('ИП Бардош') || row[0].includes('ИНН') || row[0].includes('Номер для связи')) {
							html += `<tr><td colspan="3" class="company">${row[0]}</td></tr>`;
						} else if (row[0].includes('Прайс услуг')) {
							html += `<tr><td colspan="3" class="header">${row[0]}</td></tr>`;
						} else if (row[0].includes('Данный прайс') || row[0].includes('ИП Бардош Роман')) {
							html += `<tr><td colspan="3" class="footer">${row[0]}</td></tr>`;
						} else if (row[0].includes('Дополнительная упаковка')) {
							html += `<tr><td colspan="3" class="block-title">${row[0]}</td></tr>`;
						} else if (row[0].includes('6.') && row[0].includes('.')) {
							html += `<tr><td colspan="3" class="sub-block-title">${row[0]}</td></tr>`;
						} else if (row[0].includes('.') && !row[0].includes('6.')) {
							html += `<tr><td colspan="3" class="block-title">${row[0]}</td></tr>`;
						} else {
							html += `<tr><td colspan="3" class="company">${row[0]}</td></tr>`;
						}
					} else if (row.length === 3 && row[0] === 'Услуга') {
						html += `<tr>
							<td class="table-header">${row[0]}</td>
							<td class="table-header">${row[1]}</td>
							<td class="table-header">${row[2]}</td>
						</tr>`;
					} else if (row.length === 3) {
						html += `<tr class="service-row">
							<td class="service-cell">${row[0]}</td>
							<td class="service-cell price-cell">${row[1]}</td>
							<td class="service-cell unit-cell">${row[2]}</td>
						</tr>`;
					}
				});
				
				html += `
						</table>
					</body>
					</html>
				`;
				
				// Создаем и скачиваем файл
				const blob = new Blob([html], {
					type: filename.endsWith('.html') ? 'text/html' : 'application/vnd.ms-excel'
				});
				
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = filename;
				a.click();
				URL.revokeObjectURL(url);
		}

		// Экспорт в настоящий .xlsx с выделенными заголовками, секциями и границами
		function downloadXLSX(data, filename) {
			try {
				if (typeof XLSX === 'undefined' || !XLSX || !XLSX.utils) {
					return downloadXLS(data, filename.replace(/\.xlsx$/i, '.xls'));
				}

				const k1 = numberOrZero(k1El && k1El.value);
				const k2 = numberOrZero(k2El && k2El.value);
				const k3 = numberOrZero(k3El && k3El.value);

				const xlsxData = [];
				xlsxData.push(['ЗАЯВКА НА УСЛУГИ ФУЛФИЛМЕНТА']);
				xlsxData.push(['ИП Бардош Роман Евгеньевич (ИНН 251005851477)']);
				xlsxData.push(['Тел.: 8 953 213-25-82']);
				xlsxData.push(['']);
				xlsxData.push(['ПАРАМЕТРЫ ПОСТАВКИ']);
				xlsxData.push(['Паллеты', String(k1), 'шт.']);
				xlsxData.push(['Коробы', String(k2), 'шт.']);
				xlsxData.push(['Единицы товара', String(k3), 'шт.']);
				xlsxData.push(['']);

				(data || []).forEach(row => xlsxData.push(row));

				const wb = XLSX.utils.book_new();
				const ws = XLSX.utils.aoa_to_sheet(xlsxData);

				let headerIdx = -1;
				for (let i = 0; i < xlsxData.length; i++) {
					const row = xlsxData[i];
					if (Array.isArray(row) && row.length >= 3 && String(row[0]).trim() === 'Услуга') { headerIdx = i; break; }
				}
				let lastIdx = headerIdx;
				let maxCols = 3;
				if (headerIdx !== -1) {
					for (let i = headerIdx; i < xlsxData.length; i++) {
						const row = xlsxData[i];
						if (Array.isArray(row) && row.length >= 3) { lastIdx = i; if (row.length > maxCols) maxCols = row.length; }
						else { break; }
					}
				}

				ws['!cols'] = Array.from({ length: Math.max(3, maxCols) }, (_, idx) => ({ wch: idx === 0 ? 64 : 18 }));

				const borderThin = { style: 'thin', color: { rgb: '000000' } };
				const cellBorder = { top: borderThin, bottom: borderThin, left: borderThin, right: borderThin };
				const titleFill = { patternType: 'solid', fgColor: { rgb: '1F4E78' } };
				const titleFont = { name: 'Arial', sz: 16, bold: true, color: { rgb: 'FFFFFF' } };
				const subtitleFont = { name: 'Arial', sz: 12, bold: true, color: { rgb: '2F5597' } };
				const headerFill = { patternType: 'solid', fgColor: { rgb: '4472C4' } };
				const headerFont = { name: 'Arial', sz: 12, bold: true, color: { rgb: 'FFFFFF' } };
				const headerAlign = { horizontal: 'center', vertical: 'center', wrapText: true };
				const normalFont = { name: 'Arial', sz: 11, color: { rgb: '000000' } };
				const boldFont = { name: 'Arial', sz: 11, bold: true, color: { rgb: '000000' } };
				const blockTitleFill = { patternType: 'solid', fgColor: { rgb: 'B4C6E7' } };
				const paramsFill = { patternType: 'solid', fgColor: { rgb: 'E7F3FF' } };
				const totalFill = { patternType: 'solid', fgColor: { rgb: 'FFF2CC' } };

				ws['!merges'] = ws['!merges'] || [];
				const lastCol = Math.max(2, maxCols - 1);
				const mergeAcross = (r) => ws['!merges'].push({ s: { r, c: 0 }, e: { r, c: lastCol } });
				mergeAcross(0);
				mergeAcross(1);
				mergeAcross(2);
				mergeAcross(4);

				const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
				for (let r = range.s.r; r <= range.e.r; r++) {
					const row = xlsxData[r] || [];
					const rowLen = row.length;
					const isHeaderRow = rowLen === 3 && String(row[0]).trim() === 'Услуга';
					const isDataRow = rowLen === 3 && !isHeaderRow && row[0] !== '';
					const isSingleRow = rowLen === 1;

					for (let c = 0; c < Math.max(3, maxCols, rowLen); c++) {
						const addr = XLSX.utils.encode_cell({ r, c });
						if (!ws[addr]) continue;

						if (r === 0) { ws[addr].s = { font: titleFont, fill: titleFill, alignment: { horizontal: 'center', vertical: 'center', wrapText: true } }; continue; }
						if (r === 1 || r === 2) { ws[addr].s = { font: boldFont, alignment: { horizontal: 'center', vertical: 'center', wrapText: true } }; continue; }
						if (r === 4) { ws[addr].s = { font: subtitleFont, fill: paramsFill, alignment: { horizontal: 'left', vertical: 'center', wrapText: true } }; continue; }
						if (r >= 5 && r <= 7) { ws[addr].s = { font: normalFont, alignment: { horizontal: c === 1 ? 'center' : 'left', vertical: 'center', wrapText: true }, border: cellBorder }; continue; }
						if (isSingleRow && row[0] === '') { continue; }
						if (isHeaderRow) { ws[addr].s = { font: headerFont, fill: headerFill, alignment: headerAlign, border: cellBorder }; continue; }
						if (isSingleRow && row[0] && row[0] !== '') {
							ws[addr].s = { font: subtitleFont, fill: blockTitleFill, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: cellBorder };
							if (c === 0) { ws['!merges'].push({ s: { r, c: 0 }, e: { r, c: lastCol } }); }
							continue;
						}
						if (isDataRow) {
							ws[addr].s = { font: normalFont, alignment: { horizontal: c === 1 || c === 2 ? 'center' : 'left', vertical: 'center', wrapText: true }, border: cellBorder };
							if (c === 1) ws[addr].s.font = boldFont;
							continue;
						}
						if (rowLen >= 1 && typeof row[0] === 'string' && row[0].toUpperCase().includes('ИТОГО')) {
							ws[addr].s = { font: boldFont, fill: totalFill, alignment: { horizontal: c === 0 ? 'left' : 'right', vertical: 'center', wrapText: true }, border: cellBorder };
							continue;
						}
						ws[addr].s = { font: normalFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true } };
					}
				}

				try {
					if (headerIdx !== -1) {
						const thin = { style: 'thin', color: { rgb: '000000' } };
						const thick = { style: 'thick', color: { rgb: '000000' } };
						const lastColLocal = lastCol;
						const sections = [];
						for (let i = 0; i <= xlsxData.length - 2; i++) {
							const isBlockTitle = Array.isArray(xlsxData[i]) && xlsxData[i].length === 1 && xlsxData[i][0] && xlsxData[i][0] !== '';
							const isHeaderNext = Array.isArray(xlsxData[i + 1]) && xlsxData[i + 1].length >= 3 && String(xlsxData[i + 1][0]).trim() === 'Услуга';
							if (isBlockTitle && isHeaderNext) {
								const start = i + 1;
								let end = start;
								for (let r = start; r < xlsxData.length; r++) {
									const row = xlsxData[r];
									if (Array.isArray(row) && row.length >= 3) { end = r; }
									else { break; }
								}
								sections.push({ start, end });
							}
						}
						if (sections.length === 0) { sections.push({ start: headerIdx, end: lastIdx }); }
						sections.forEach(({ start, end }) => {
							for (let r = start; r <= end; r++) {
								for (let c = 0; c <= lastColLocal; c++) {
									const addr = XLSX.utils.encode_cell({ r, c });
									if (!ws[addr]) continue;
									ws[addr].s = ws[addr].s || {};
									ws[addr].s.border = ws[addr].s.border || {};
									if (!ws[addr].s.border.top) ws[addr].s.border.top = thin;
									if (!ws[addr].s.border.bottom) ws[addr].s.border.bottom = thin;
									if (!ws[addr].s.border.left) ws[addr].s.border.left = thin;
									if (!ws[addr].s.border.right) ws[addr].s.border.right = thin;
								}
							}
							for (let r = start; r <= end; r++) {
								for (let c = 0; c <= lastColLocal; c++) {
									const addr = XLSX.utils.encode_cell({ r, c });
									if (!ws[addr]) continue;
									if (r === start) ws[addr].s.border.top = thick;
									if (r === end) ws[addr].s.border.bottom = thick;
									if (c === 0) ws[addr].s.border.left = thick;
									if (c === lastColLocal) ws[addr].s.border.right = thick;
								}
							}
						});
					}
				} catch (_) {}

				try {
					if (headerIdx !== -1) {
						const colRef = XLSX.utils.encode_col(lastCol);
						const filterRef = `A${headerIdx + 1}:${colRef}${lastIdx + 1}`;
						ws['!autofilter'] = { ref: filterRef };
						ws['!freeze'] = { xSplit: 0, ySplit: headerIdx + 1, topLeftCell: `A${headerIdx + 2}` };
					}
				} catch (_) {}

				XLSX.utils.book_append_sheet(wb, ws, 'Заявка на услуги');
				XLSX.writeFile(wb, filename);
			} catch (e) {
				try { downloadXLS(data, filename.replace(/\.xlsx$/i, '.xls')); } catch (_) {}
			}
		}

		// Генерик AOA -> XLSX с шапкой и границами для прайса
		function downloadAOA_XLSX(data, filename, titleText = '') {
			try {
				if (typeof XLSX === 'undefined' || !XLSX || !XLSX.utils) {
					return downloadXLS(data, filename.replace(/\.xlsx$/i, '.xls'));
				}
				const aoa = [];
				if (titleText) aoa.push([titleText]);
				(data || []).forEach(r => aoa.push(r));
				const wb = XLSX.utils.book_new();
				const ws = XLSX.utils.aoa_to_sheet(aoa);

				let headerIdx = -1;
				let maxCols = 3;
				for (let i = 0; i < aoa.length; i++) {
					const row = aoa[i];
					if (Array.isArray(row) && row.length >= 3 && String(row[0]).trim() === 'Услуга') { headerIdx = i; break; }
				}
				let lastIdx = headerIdx;
				if (headerIdx !== -1) {
					for (let i = headerIdx; i < aoa.length; i++) {
						const row = aoa[i];
						if (Array.isArray(row) && row.length >= 3) { lastIdx = i; if (row.length > maxCols) maxCols = row.length; }
						else { break; }
					}
				}
				ws['!cols'] = Array.from({ length: Math.max(3, maxCols) }, (_, idx) => ({ wch: idx === 0 ? 64 : 18 }));

				const borderThin = { style: 'thin', color: { rgb: '000000' } };
				const cellBorder = { top: borderThin, bottom: borderThin, left: borderThin, right: borderThin };
				const titleFill = { patternType: 'solid', fgColor: { rgb: '1F4E78' } };
				const titleFont = { name: 'Arial', sz: 16, bold: true, color: { rgb: 'FFFFFF' } };
				const headerFill = { patternType: 'solid', fgColor: { rgb: '4472C4' } };
				const headerFont = { name: 'Arial', sz: 12, bold: true, color: { rgb: 'FFFFFF' } };
				const headerAlign = { horizontal: 'center', vertical: 'center', wrapText: true };
				const normalFont = { name: 'Arial', sz: 11, color: { rgb: '000000' } };
				const boldFont = { name: 'Arial', sz: 11, bold: true, color: { rgb: '000000' } };
				const blockTitleFill = { patternType: 'solid', fgColor: { rgb: 'B4C6E7' } };
				const totalFill = { patternType: 'solid', fgColor: { rgb: 'FFF2CC' } };

				ws['!merges'] = ws['!merges'] || [];
				if (titleText) {
					const lastCol = Math.max(2, maxCols - 1);
					ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: lastCol } });
				}

				const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
				for (let r = range.s.r; r <= range.e.r; r++) {
					const row = aoa[r] || [];
					const rowLen = row.length;
					const isHeaderRow = rowLen >= 3 && String(row[0]).trim() === 'Услуга';
					const isDataRow = rowLen >= 3 && !isHeaderRow && row[0] !== '';
					const isSingleRow = rowLen === 1;

					for (let c = 0; c < Math.max(3, maxCols, rowLen); c++) {
						const addr = XLSX.utils.encode_cell({ r, c });
						if (!ws[addr]) continue;

						if (titleText && r === 0) { ws[addr].s = { font: titleFont, fill: titleFill, alignment: { horizontal: 'center', vertical: 'center', wrapText: true } }; continue; }
						if (isHeaderRow) { ws[addr].s = { font: headerFont, fill: headerFill, alignment: headerAlign, border: cellBorder }; continue; }
						if (isSingleRow && row[0] && row[0] !== '') { ws[addr].s = { font: boldFont, fill: blockTitleFill, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: cellBorder }; continue; }
						if (isDataRow) {
							ws[addr].s = { font: normalFont, alignment: { horizontal: c === 1 || c === 2 ? 'center' : 'left', vertical: 'center', wrapText: true }, border: cellBorder };
							if (c === 1) ws[addr].s.font = boldFont;
							continue;
						}
						if (rowLen >= 1 && typeof row[0] === 'string' && row[0].toUpperCase().includes('ИТОГО')) { ws[addr].s = { font: boldFont, fill: totalFill, alignment: { horizontal: c === 0 ? 'left' : 'right', vertical: 'center', wrapText: true }, border: cellBorder }; continue; }
						ws[addr].s = { font: normalFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true } };
					}
				}

				if (headerIdx !== -1) {
					const thin = { style: 'thin', color: { rgb: '000000' } };
					const thick = { style: 'thick', color: { rgb: '000000' } };
					const lastColLocal = Math.max(2, maxCols - 1);
					const sections = [];
					for (let i = 0; i <= aoa.length - 2; i++) {
						const isBlockTitle = Array.isArray(aoa[i]) && aoa[i].length === 1 && aoa[i][0] && aoa[i][0] !== '' && aoa[i][0] !== titleText;
						const isHeaderNext = Array.isArray(aoa[i + 1]) && aoa[i + 1].length >= 3 && String(aoa[i + 1][0]).trim() === 'Услуга';
						if (isBlockTitle && isHeaderNext) {
							const start = i + 1;
							let end = start;
							for (let r = start; r < aoa.length; r++) {
								const row = aoa[r];
								if (Array.isArray(row) && row.length >= 3) { end = r; }
								else { break; }
							}
							sections.push({ start, end });
						}
					}
					if (sections.length === 0) { sections.push({ start: headerIdx, end: lastIdx }); }
					sections.forEach(({ start, end }) => {
						for (let r = start; r <= end; r++) {
							for (let c = 0; c <= lastColLocal; c++) {
								const addr = XLSX.utils.encode_cell({ r, c });
								if (!ws[addr]) continue;
								ws[addr].s = ws[addr].s || {};
								ws[addr].s.border = ws[addr].s.border || {};
								if (!ws[addr].s.border.top) ws[addr].s.border.top = thin;
								if (!ws[addr].s.border.bottom) ws[addr].s.border.bottom = thin;
								if (!ws[addr].s.border.left) ws[addr].s.border.left = thin;
								if (!ws[addr].s.border.right) ws[addr].s.border.right = thin;
							}
						}
						for (let r = start; r <= end; r++) {
							for (let c = 0; c <= lastColLocal; c++) {
								const addr = XLSX.utils.encode_cell({ r, c });
								if (!ws[addr]) continue;
								if (r === start) ws[addr].s.border.top = thick;
								if (r === end) ws[addr].s.border.bottom = thick;
								if (c === 0) ws[addr].s.border.left = thick;
								if (c === lastColLocal) ws[addr].s.border.right = thick;
							}
						}
					});
					const colRef = XLSX.utils.encode_col(Math.max(2, maxCols - 1));
					ws['!autofilter'] = { ref: `A${headerIdx + 1}:${colRef}${lastIdx + 1}` };
					ws['!freeze'] = { xSplit: 0, ySplit: headerIdx + 1, topLeftCell: `A${headerIdx + 2}` };
				}

				XLSX.utils.book_append_sheet(wb, ws, titleText ? 'Прайс' : 'Лист1');
				XLSX.writeFile(wb, filename);
			} catch (e) {
				try { downloadXLS(data, filename.replace(/\.xlsx$/i, '.xls')); } catch (_) {}
			}
		}

		function downloadXLS(data, filename) {
			// Получаем параметры поставки
			const k1 = numberOrZero(k1El.value);
			const k2 = numberOrZero(k2El.value);
			const k3 = numberOrZero(k3El.value);
			
			// Создаем красивую HTML таблицу для Excel
			let html = `
				<html xmlns:o="urn:schemas-microsoft-com:office:office" 
				      xmlns:x="urn:schemas-microsoft-com:office:excel" 
				      xmlns="http://www.w3.org/TR/REC-html40">
				<head>
					<meta charset="UTF-8">
					<!--[if gte mso 9]>
					<xml>
						<x:ExcelWorkbook>
							<x:ExcelWorksheets>
								<x:ExcelWorksheet>
									<x:Name>Заявка на услуги</x:Name>
									<x:WorksheetOptions>
										<x:DefaultRowHeight>285</x:DefaultRowHeight>
									</x:WorksheetOptions>
								</x:ExcelWorksheet>
							</x:ExcelWorksheets>
						</x:ExcelWorkbook>
					</xml>
					<![endif]-->
					<style>
						body { 
							font-family: Arial, sans-serif; 
							font-size: 12px; 
							margin: 0; 
							padding: 15px; 
							background: white;
							color: #000000;
						}
						
						.container {
							background: white;
							border: 1px solid #cccccc;
						}
						
						.header {
							background: #4472C4;
							color: #ffffff;
							padding: 15px;
							text-align: center;
						}
						
						.header h1 {
							margin: 0;
							font-size: 20px;
							font-weight: bold;
							color: #ffffff;
							text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
						}
						
						.header p {
							margin: 5px 0 0 0;
							font-size: 14px;
							font-weight: bold;
							color: #ffffff;
						}
						
						.content {
							padding: 15px;
						}
						
						.parameters-block {
							background: #E7F3FF;
							padding: 12px;
							margin-bottom: 15px;
							border: 1px solid #4472C4;
						}
						
						.parameters-block h3 {
							margin: 0 0 8px 0;
							color: #2F5597;
							font-size: 16px;
							font-weight: bold;
							text-transform: uppercase;
							letter-spacing: 1px;
						}
						
						.params-grid {
							display: table;
							width: 100%;
						}
						
						.params-grid div {
							display: table-cell;
							width: 33.33%;
							font-size: 12px;
						}
						
						table { 
							border-collapse: collapse; 
							width: 100%; 
							margin: 15px 0;
							background: white;
							border: 1px solid #000000;
						}
						
						th { 
							background: #4472C4;
							color: #000000 !important; 
							font-weight: bold; 
							text-align: center; 
							padding: 10px 8px; 
							border: 1px solid #000000;
							font-size: 11px;
						}
						
						td { 
							padding: 8px; 
							border: 1px solid #000000; 
							text-align: left;
							font-size: 11px;
							vertical-align: middle;
						}
						
						tr:nth-child(even) {
							background: #F2F2F2;
						}
						
						.total-row { 
							background: #E7F3FF;
							font-weight: bold; 
							font-size: 12px;
						}
						
						.total-row td {
							border-top: 2px solid #4472C4;
							border-bottom: 2px solid #4472C4;
						}
						
						.price-col { 
							text-align: right; 
							font-weight: bold;
						}
						
						.service-name {
							font-weight: bold;
						}
						
						.percentage {
							color: #FF6600;
							font-weight: bold;
						}
						
						.amount {
							color: #000000;
							font-weight: bold;
						}
						
						.footer {
							background: #F2F2F2;
							padding: 10px;
							text-align: center;
							font-size: 10px;
							border-top: 1px solid #cccccc;
						}
						
						.empty-row td {
							height: 5px;
							padding: 0;
							border: none;
							background: transparent;
						}
					</style>
				</head>
				<body>
					<div class="container">
						<div class="header">
							<h1>ЗАЯВКА НА УСЛУГИ ФУЛФИЛМЕНТА</h1>
							<p>Дата: ${new Date().toLocaleDateString('ru-RU')}</p>
						</div>
						<div class="content">
							<div class="parameters-block">
								<h3>ПАРАМЕТРЫ ПОСТАВКИ</h3>
								<div class="params-grid">
									<div><strong>Паллеты:</strong> ${k1} шт.</div>
									<div><strong>Коробы:</strong> ${k2} шт.</div>
									<div><strong>Единицы товара:</strong> ${k3} шт.</div>
								</div>
							</div>
			`;
			
			// Генерируем красивую таблицу
			html += '<table>';
			
			data.forEach((row, index) => {
				if (index === 0) {
					// Заголовок таблицы
					html += '<tr>';
					row.forEach(cell => {
						html += `<th style="color: #000000;">${cell}</th>`;
					});
					html += '</tr>';
				} else if (row[0] === 'ИТОГО:') {
					// Итоговая строка
					html += '<tr class="total-row">';
					row.forEach((cell, cellIndex) => {
						if (cellIndex === 0) {
							html += `<td class="service-name" style="color: #000000;">${cell}</td>`;
						} else if (cellIndex === 6 || cellIndex === 7) {
							// НДС сумма и Общая сумма
							html += `<td class="price-col amount" style="color: #000000;">${cell} ₽</td>`;
						} else {
							html += `<td class="price-col amount" style="color: #000000;">${cell}</td>`;
						}
					});
					html += '</tr>';
				} else if (row[0] === '') {
					// Пустая строка
					html += '<tr class="empty-row"><td colspan="8"></td></tr>';
				} else {
					// Строка с услугой
					html += '<tr>';
					row.forEach((cell, cellIndex) => {
						let cellClass = '';
						let cellContent = cell;
						
						if (cellIndex === 0) {
							// Название услуги
							cellClass = 'service-name';
						} else if (cellIndex === 1) {
							// Стоимость за ед.
							cellClass = 'price-col amount';
							if (cell !== '—') cellContent = `${cell} ₽`;
						} else if (cellIndex === 2) {
							// Количество
							cellClass = 'price-col';
						} else if (cellIndex === 3) {
							// Процент скидки
							cellClass = 'price-col percentage';
							if (cell === '—') cellContent = '—';
						} else if (cellIndex === 4) {
							// Цена по скидке за ед.
							cellClass = 'price-col amount';
							if (cell !== '—') cellContent = `${cell} ₽`;
						} else if (cellIndex === 5) {
							// Процент НДС
							cellClass = 'price-col percentage';
							if (cell === '—') cellContent = '—';
						} else if (cellIndex === 6) {
							// Сумма НДС
							cellClass = 'price-col amount';
							if (cell !== '—') cellContent = `${cell} ₽`;
						} else if (cellIndex === 7) {
							// Общая сумма
							cellClass = 'price-col amount';
							cellContent = `${cell} ₽`;
						}
						
						html += `<td class="${cellClass}" style="color: #000000;">${cellContent}</td>`;
					});
					html += '</tr>';
				}
			});
			
			html += `
						</table>
						</div>
						<div class="footer">
							<p><strong>ИП Бардош Роман Евгеньевич</strong> | ИНН 251005851477</p>
							<p>Телефон: 89532132582 | Email: info@fulfillment-vladivostok.ru</p>
							<p>Высокотехнологичный фулфилмент во Владивостоке WB|Ozon</p>
						</div>
					</div>
				</body>
				</html>
			`;
			
			// Создаем и скачиваем файл как Excel
			const blob = new Blob([html], {
				type: 'application/vnd.ms-excel'
			});
			
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename.replace('.html', '.xls');
			a.click();
			URL.revokeObjectURL(url);
		}

			function saveToStorage() {
				const data = window.calculateTotals();
				const selectedServices = CONFIG.services.map((service, index) => {
					const checkbox = document.getElementById(`service_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const selectedServices2 = CONFIG.services2.map((service, index) => {
					const checkbox = document.getElementById(`service_2_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const selectedServices3 = CONFIG.services3.map((service, index) => {
					const checkbox = document.getElementById(`service_3_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const selectedServices4 = CONFIG.services4.map((service, index) => {
					const checkbox = document.getElementById(`service_4_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const selectedServices5 = CONFIG.services5.map((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					return checkbox ? checkbox.checked : false;
				});
				const serviceQuantities = CONFIG.services.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				const serviceQuantities2 = CONFIG.services2.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_2_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				const serviceQuantities3 = CONFIG.services3.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_3_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				const serviceQuantities4 = CONFIG.services4.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_4_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				const serviceQuantities5 = CONFIG.services5.map((service, index) => {
					const idx = `5_${index}`;
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				const serviceDays5 = CONFIG.services5.map((service, index) => {
					const idx = `5_${index}`;
					const daysInput = document.getElementById(`service_days_${idx}`);
					return numberOrZero(daysInput ? daysInput.value : 0);
				});
				// Services6
				const selectedServices6 = {};
				const serviceQuantities6 = {};
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					selectedServices6[subBlockName] = subBlock.items.map((service, itemIndex) => {
						const checkbox = document.getElementById(`service_6_${blockIndex}_${itemIndex}`);
						return checkbox ? checkbox.checked : false;
					});
					serviceQuantities6[subBlockName] = subBlock.items.map((service, itemIndex) => {
						const qtyInput = document.getElementById(`service_qty_6_${blockIndex}_${itemIndex}`);
						return numberOrZero(qtyInput ? qtyInput.value : 0);
					});
				});
				// Services7
				const selectedServices7 = CONFIG.services7.map((service, index) => {
					const checkbox = document.getElementById(`service_7_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const serviceQuantities7 = CONFIG.services7.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_7_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				// Services8
				const selectedServices8 = CONFIG.services8.map((service, index) => {
					const checkbox = document.getElementById(`service_8_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const serviceQuantities8 = CONFIG.services8.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_8_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				// Services9
				const selectedServices9 = CONFIG.services9.map((service, index) => {
					const checkbox = document.getElementById(`service_9_${index}`);
					return checkbox ? checkbox.checked : false;
				});
				const serviceQuantities9 = CONFIG.services9.map((service, index) => {
					const qtyInput = document.getElementById(`service_qty_9_${index}`);
					return numberOrZero(qtyInput ? qtyInput.value : 0);
				});
				const payload = {
					k1: numberOrZero(k1El ? k1El.value : 0),
					k2: numberOrZero(k2El ? k2El.value : 0),
					k3: numberOrZero(k3El ? k3El.value : 0),
					discount: numberOrZero(discountEl.value),
					vat: numberOrZero(vatEl.value),
					note: noteEl.value,
					selectedServices,
					selectedServices2,
					selectedServices3,
					selectedServices4,
					selectedServices5,
					serviceQuantities,
					serviceQuantities2,
					serviceQuantities3,
					serviceQuantities4,
					serviceQuantities5,
					serviceDays5,
					selectedServices6,
					serviceQuantities6,
					selectedServices7,
					serviceQuantities7,
					selectedServices8,
					serviceQuantities8,
					selectedServices9,
					serviceQuantities9,
				};
				localStorage.setItem('price_calc_v1', JSON.stringify(payload));
			}

			function loadFromStorage() {
				try {
					const saved = JSON.parse(localStorage.getItem('price_calc_v1') || 'null');
					if (!saved) return false;
					if (k1El) k1El.value = saved.k1 ?? 0;
					if (k2El) k2El.value = saved.k2 ?? 0;
					if (k3El) k3El.value = saved.k3 ?? 0;
					discountEl.value = saved.discount ?? 0;
					vatEl.value = saved.vat ?? 20;
					noteEl.value = saved.note || '';
					
					if (saved.selectedServices) {
						saved.selectedServices.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.selectedServices2) {
						saved.selectedServices2.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_2_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.selectedServices3) {
						saved.selectedServices3.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_3_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.selectedServices4) {
						saved.selectedServices4.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_4_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.selectedServices5) {
						saved.selectedServices5.forEach((checked, index) => {
							const idx = `5_${index}`;
							const checkbox = document.getElementById(`service_${idx}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.serviceQuantities) {
						saved.serviceQuantities.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					if (saved.serviceQuantities2) {
						saved.serviceQuantities2.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_2_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					if (saved.serviceQuantities3) {
						saved.serviceQuantities3.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_3_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					if (saved.serviceQuantities4) {
						saved.serviceQuantities4.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_4_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					if (saved.serviceQuantities5) {
						saved.serviceQuantities5.forEach((q, index) => {
							const idx = `5_${index}`;
							const qtyInput = document.getElementById(`service_qty_${idx}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					if (saved.serviceDays5) {
						saved.serviceDays5.forEach((d, index) => {
							const idx = `5_${index}`;
							const daysInput = document.getElementById(`service_days_${idx}`);
							if (daysInput) daysInput.value = String(numberOrZero(d));
						});
					}
					// Services6
					if (saved.selectedServices6) {
						Object.keys(saved.selectedServices6).forEach((subBlockName) => {
							saved.selectedServices6[subBlockName].forEach((checked, index) => {
								const checkbox = document.getElementById(`service_6_${Object.keys(CONFIG.services6).indexOf(subBlockName)}_${index}`);
								if (checkbox) checkbox.checked = checked;
							});
						});
					}
					if (saved.serviceQuantities6) {
						Object.keys(saved.serviceQuantities6).forEach((subBlockName) => {
						saved.serviceQuantities6[subBlockName].forEach((q, index) => {
							const subIdx = Object.keys(CONFIG.services6).indexOf(subBlockName);
							const qtyInput = document.getElementById(`service_qty_6_${subIdx}_${index}`);
							if (!qtyInput) return;
							if (subBlockName === 'Коробки') {
								qtyInput.value = '0';
							} else {
								qtyInput.value = String(numberOrZero(q));
							}
						});
						});
					}
					// Services7
					if (saved.selectedServices7) {
						saved.selectedServices7.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_7_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.serviceQuantities7) {
						saved.serviceQuantities7.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_7_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					// Services8
					if (saved.selectedServices8) {
						saved.selectedServices8.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_8_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.serviceQuantities8) {
						saved.serviceQuantities8.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_8_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					// Services9
					if (saved.selectedServices9) {
						saved.selectedServices9.forEach((checked, index) => {
							const checkbox = document.getElementById(`service_9_${index}`);
							if (checkbox) checkbox.checked = checked;
						});
					}
					if (saved.serviceQuantities9) {
						saved.serviceQuantities9.forEach((q, index) => {
							const qtyInput = document.getElementById(`service_qty_9_${index}`);
							if (qtyInput) qtyInput.value = String(numberOrZero(q));
						});
					}
					
					window.calculateTotals();
					return true;
				} catch (_) { return false; }
			}

			function resetAllCheckboxes() {
				// Сбрасываем все галочки во всех блоках
				CONFIG.services.forEach((service, index) => {
					const checkbox = document.getElementById(`service_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				CONFIG.services2.forEach((service, index) => {
					const checkbox = document.getElementById(`service_2_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_2_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				CONFIG.services3.forEach((service, index) => {
					const checkbox = document.getElementById(`service_3_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_3_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				CONFIG.services4.forEach((service, index) => {
					const checkbox = document.getElementById(`service_4_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_4_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_${idx}`);
					if (qtyInput) qtyInput.value = 0;
					const daysInput = document.getElementById(`service_days_${idx}`);
					if (daysInput) daysInput.value = 0;
				});
				CONFIG.services7.forEach((service, index) => {
					const checkbox = document.getElementById(`service_7_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_7_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				CONFIG.services8.forEach((service, index) => {
					const checkbox = document.getElementById(`service_8_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_8_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				CONFIG.services9.forEach((service, index) => {
					const checkbox = document.getElementById(`service_9_${index}`);
					if (checkbox) checkbox.checked = false;
					const qtyInput = document.getElementById(`service_qty_9_${index}`);
					if (qtyInput) qtyInput.value = 0;
				});
				// Services6 (объект)
				Object.keys(CONFIG.services6).forEach((subBlockName, blockIndex) => {
					const subBlock = CONFIG.services6[subBlockName];
					subBlock.items.forEach((service, itemIndex) => {
						const checkbox = document.getElementById(`service_6_${blockIndex}_${itemIndex}`);
						if (checkbox) checkbox.checked = false;
						const qtyInput = document.getElementById(`service_qty_6_${blockIndex}_${itemIndex}`);
						if (qtyInput) qtyInput.value = 0;
					});
				});
			}

			// Wire global controls
			resetBtn.addEventListener('click', () => {
				if (!confirm('Сбросить все данные?')) return;
				CONFIG.services.forEach((service, index) => {
					const checkbox = document.getElementById(`service_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services2.forEach((service, index) => {
					const checkbox = document.getElementById(`service_2_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services3.forEach((service, index) => {
					const checkbox = document.getElementById(`service_3_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services4.forEach((service, index) => {
					const checkbox = document.getElementById(`service_4_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services5.forEach((service, index) => {
					const idx = `5_${index}`;
					const checkbox = document.getElementById(`service_${idx}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services7.forEach((service, index) => {
					const checkbox = document.getElementById(`service_7_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services8.forEach((service, index) => {
					const checkbox = document.getElementById(`service_8_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				CONFIG.services9.forEach((service, index) => {
					const checkbox = document.getElementById(`service_9_${index}`);
					if (checkbox) checkbox.checked = false;
				});
				discountEl.value = 0;
				vatEl.value = 20;
				noteEl.value = '';
				if (k1El) k1El.value = 0;
				if (k2El) k2El.value = 0;
				if (k3El) k3El.value = 0;
				syncQuantitiesFromContext();
				window.calculateTotals();
				saveToStorage();
			});
			[discountEl, vatEl, noteEl].forEach(el => {
				if (!el) return;
				el.addEventListener('input', () => { window.calculateTotals(); saveToStorage(); });
				el.addEventListener('change', () => { window.calculateTotals(); saveToStorage(); });
			});
			[k1El, k2El, k3El].forEach(el => {
				if (!el) return;
				el.addEventListener('input', () => { syncQuantitiesFromContext(); window.calculateTotals(); saveToStorage(); });
				el.addEventListener('change', () => { syncQuantitiesFromContext(); window.calculateTotals(); saveToStorage(); });
			});
			generatePricePDFBtn.addEventListener('click', () => generatePricePDF());
			generatePriceXLSBtn.addEventListener('click', () => generatePriceXLS());
			generateOrderXLSBtn.addEventListener('click', () => generateOrderXLS());

			// Init
			// Ждем полной загрузки DOM
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', () => {
					renderServices();
					// Всегда сбрасываем галочки и значения при загрузке
					resetAllCheckboxes();
					if (k1El) k1El.value = 0;
					if (k2El) k2El.value = 0;
					if (k3El) k3El.value = 0;
					discountEl.value = 0;
					vatEl.value = 20;
					noteEl.value = '';
					
					// Пытаемся загрузить сохраненные данные
					if (loadFromStorage()) {
						// Если есть сохраненные данные, они перезапишут значения выше
						window.calculateTotals();
					} else {
						// Если нет сохраненных данных, используем сброшенные значения
						syncQuantitiesFromContext();
						window.calculateTotals();
					}
				});
			} else {
				renderServices();
				// Всегда сбрасываем галочки и значения при загрузке
				resetAllCheckboxes();
				if (k1El) k1El.value = 0;
				if (k2El) k2El.value = 0;
				if (k3El) k3El.value = 0;
				discountEl.value = 0;
				vatEl.value = 20;
				noteEl.value = '';
				
				// Пытаемся загрузить сохраненные данные
				if (loadFromStorage()) {
					// Если есть сохраненные данные, они перезапишут значения выше
					window.calculateTotals();
				} else {
					// Если нет сохраненных данных, используем сброшенные значения
					syncQuantitiesFromContext();
					window.calculateTotals();
				}
			}
		})();
	</script>
</body>
</html>
